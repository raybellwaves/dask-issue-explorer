{
    "url": "https://api.github.com/repos/dask/dask/issues/10659",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/10659/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/10659/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/10659/events",
    "html_url": "https://github.com/dask/dask/issues/10659",
    "id": 2018419293,
    "node_id": "I_kwDOAbcwm854TqJd",
    "number": 10659,
    "title": "ValueError: Categorical categories cannot be null when reading parquet file with no category",
    "user": {
        "login": "trgmg",
        "id": 142340341,
        "node_id": "U_kgDOCHvw9Q",
        "avatar_url": "https://avatars.githubusercontent.com/u/142340341?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/trgmg",
        "html_url": "https://github.com/trgmg",
        "followers_url": "https://api.github.com/users/trgmg/followers",
        "following_url": "https://api.github.com/users/trgmg/following{/other_user}",
        "gists_url": "https://api.github.com/users/trgmg/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/trgmg/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/trgmg/subscriptions",
        "organizations_url": "https://api.github.com/users/trgmg/orgs",
        "repos_url": "https://api.github.com/users/trgmg/repos",
        "events_url": "https://api.github.com/users/trgmg/events{/privacy}",
        "received_events_url": "https://api.github.com/users/trgmg/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 3880424463,
            "node_id": "LA_kwDOAbcwm87nSpQP",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20triage",
            "name": "needs triage",
            "color": "eeeeee",
            "default": false,
            "description": "Needs a response from a contributor"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-11-30T11:15:33Z",
    "updated_at": "2023-11-30T11:15:46Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "**Describe the issue**:\r\nWhen reading a parquet file (engine: pyarrow) that contains a categorical column where all values are null, dask throws a \"ValueError: Categorical categories cannot be null\". Pandas also doesn't do great, transforming the column into dtype: object.\r\n\r\nFor me it happens when a partition doesn't contain a single category but only null values. But below is a smaller example.\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\nimport dask.dataframe as dd\r\nimport pandas as pd\r\n\r\nfile = \"data.parquet\"\r\n\r\ndf = pd.DataFrame({\"A\": [None, None, None]})\r\ndf[\"A\"] = df[\"A\"].astype(\"category\")\r\nprint(\"Pandas dataframe:\")\r\nprint(df)\r\n\r\nprint(\"Dask dataframe:\")\r\nprint(dd.from_pandas(df, npartitions=2).compute()) # works just fine\r\n\r\ndf.to_parquet(file) # or stored with dask, doesn't matter\r\n\r\nprint(\"Read with pandas:\")\r\ndf = pd.read_parquet(file)\r\nprint(df[\"A\"]) #dtype: object\r\n\r\nprint(\"Read with dask:\")\r\ndf = dd.read_parquet(file)\r\nprint(df)\r\nprint(df.compute()) # Throws ValueError\r\n```\r\n\r\nThe error:\r\n```\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\trgmg\\main.py\", line 23, in <module>\r\n    print(df.compute())\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\base.py\", line 342, in compute\r\n    (result,) = compute(self, traverse=False, **kwargs)\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\base.py\", line 628, in compute\r\n    results = schedule(dsk, keys, **kwargs)\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\dataframe\\io\\parquet\\core.py\", line 96, in __call__\r\n    return read_parquet_part(\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\dataframe\\io\\parquet\\core.py\", line 659, in read_parquet_part\r\n    dfs = [\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\dataframe\\io\\parquet\\core.py\", line 660, in <listcomp>\r\n    func(\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\dataframe\\io\\parquet\\arrow.py\", line 645, in read_partition\r\n    df = cls._arrow_table_to_pandas(\r\n  File \"C:\\Users\\...\\lib\\site-packages\\dask\\dataframe\\io\\parquet\\arrow.py\", line 1851, in _arrow_table_to_pandas\r\n    res = arrow_table.to_pandas(categories=categories, **_kwargs)\r\n  File \"pyarrow\\array.pxi\", line 867, in pyarrow.lib._PandasConvertible.to_pandas\r\n  File \"pyarrow\\table.pxi\", line 4085, in pyarrow.lib.Table._to_pandas\r\n  File \"C:\\Users\\...\\lib\\site-packages\\pyarrow\\pandas_compat.py\", line 772, in table_to_blockmanager\r\n    blocks = _table_to_blocks(options, table, categories, ext_columns_dtypes)\r\n  File \"C:\\Users\\...\\lib\\site-packages\\pyarrow\\pandas_compat.py\", line 1122, in _table_to_blocks\r\n    return [_reconstruct_block(item, columns, extension_columns)\r\n  File \"C:\\Users\\...\\lib\\site-packages\\pyarrow\\pandas_compat.py\", line 1122, in <listcomp>\r\n    return [_reconstruct_block(item, columns, extension_columns)\r\n  File \"C:\\Users\\...\\lib\\site-packages\\pyarrow\\pandas_compat.py\", line 712, in _reconstruct_block\r\n    cat = _pandas_api.categorical_type.from_codes(\r\n  File \"C:\\Users\\...\\lib\\site-packages\\pandas\\core\\dtypes\\dtypes.py\", line 567, in validate_categories\r\n    raise ValueError(\"Categorical categories cannot be null\")\r\nValueError: Categorical categories cannot be null\r\n```\r\n\r\n**Anything else we need to know?** :)\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2023.9.3\r\n- Python version: Python 3.10.13\r\n- Operating System: Windows 10\r\n- Install method (conda, pip, source): pip\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/10659/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/10659/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}