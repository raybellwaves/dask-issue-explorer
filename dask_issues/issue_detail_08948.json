{
    "url": "https://api.github.com/repos/dask/dask/issues/8948",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/8948/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/8948/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/8948/events",
    "html_url": "https://github.com/dask/dask/issues/8948",
    "id": 1208249145,
    "node_id": "I_kwDOAbcwm85IBGs5",
    "number": 8948,
    "title": "`matmul` doesn't fail fast for shape mismatches in some cases",
    "user": {
        "login": "tomwhite",
        "id": 85085,
        "node_id": "MDQ6VXNlcjg1MDg1",
        "avatar_url": "https://avatars.githubusercontent.com/u/85085?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tomwhite",
        "html_url": "https://github.com/tomwhite",
        "followers_url": "https://api.github.com/users/tomwhite/followers",
        "following_url": "https://api.github.com/users/tomwhite/following{/other_user}",
        "gists_url": "https://api.github.com/users/tomwhite/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tomwhite/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tomwhite/subscriptions",
        "organizations_url": "https://api.github.com/users/tomwhite/orgs",
        "repos_url": "https://api.github.com/users/tomwhite/repos",
        "events_url": "https://api.github.com/users/tomwhite/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tomwhite/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2022-04-19T11:53:42Z",
    "updated_at": "2022-08-02T16:12:55Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "<!-- Please include a self-contained copy-pastable example that generates the issue if possible.\r\n\r\nPlease be concise with code posted. See guidelines below on how to provide a good bug report:\r\n\r\n- Craft Minimal Bug Reports http://matthewrocklin.com/blog/work/2018/02/28/minimal-bug-reports\r\n- Minimal Complete Verifiable Examples https://stackoverflow.com/help/mcve\r\n\r\nBug reports that follow these guidelines are easier to diagnose, and so are often handled much more quickly.\r\n-->\r\n\r\n**What happened**: calling `matmul` with incompatible array sizes doesn't always fail immediately\r\n\r\n**What you expected to happen**: if the array sizes are incompatible, then the operation should (consistently) fail immediately, and not wait until `compute` is called in some cases.\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\n>>> import dask.array as da\r\n>>> da.matmul(da.ones(1), da.ones(3))\r\ndask.array<getitem, shape=(), dtype=float64, chunksize=(), chunktype=numpy.ndarray>\r\n>>> da.matmul(da.ones(1), da.ones(3)).compute() # fails on compute\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/tom/projects-workspace/dask/dask/base.py\", line 292, in compute\r\n    (result,) = compute(self, traverse=False, **kwargs)\r\n  File \"/Users/tom/projects-workspace/dask/dask/base.py\", line 575, in compute\r\n    results = schedule(dsk, keys, **kwargs)\r\n  File \"/Users/tom/projects-workspace/dask/dask/threaded.py\", line 81, in get\r\n    results = get_async(\r\n  File \"/Users/tom/projects-workspace/dask/dask/local.py\", line 508, in get_async\r\n    raise_exception(exc, tb)\r\n  File \"/Users/tom/projects-workspace/dask/dask/local.py\", line 316, in reraise\r\n    raise exc\r\n  File \"/Users/tom/projects-workspace/dask/dask/local.py\", line 221, in execute_task\r\n    result = _execute_task(task, data)\r\n  File \"/Users/tom/projects-workspace/dask/dask/core.py\", line 119, in _execute_task\r\n    return func(*(_execute_task(a, cache) for a in args))\r\n  File \"/Users/tom/projects-workspace/dask/dask/core.py\", line 119, in <genexpr>\r\n    return func(*(_execute_task(a, cache) for a in args))\r\n  File \"/Users/tom/projects-workspace/dask/dask/core.py\", line 119, in _execute_task\r\n    return func(*(_execute_task(a, cache) for a in args))\r\n  File \"/Users/tom/projects-workspace/dask/dask/optimization.py\", line 990, in __call__\r\n    return core.get(self.dsk, self.outkey, dict(zip(self.inkeys, args)))\r\n  File \"/Users/tom/projects-workspace/dask/dask/core.py\", line 149, in get\r\n    result = _execute_task(task, cache)\r\n  File \"/Users/tom/projects-workspace/dask/dask/core.py\", line 119, in _execute_task\r\n    return func(*(_execute_task(a, cache) for a in args))\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/routines.py\", line 402, in _matmul\r\n    chunk = xp.matmul(a, b)\r\nValueError: matmul: Input operand 1 has a mismatch in its core dimension 0, with gufunc signature (n?,k),(k,m?)->(n?,m?) (size 3 is different from 1)\r\n>>> da.matmul(da.ones(2), da.ones(3)) # fails without compute\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/routines.py\", line 446, in matmul\r\n    out = blockwise(\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/blockwise.py\", line 174, in blockwise\r\n    chunkss, arrays = unify_chunks(*args)\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/core.py\", line 3812, in unify_chunks\r\n    arrays.append(a.rechunk(chunks))\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/core.py\", line 2647, in rechunk\r\n    return rechunk(self, chunks, threshold, block_size_limit, balance)\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/rechunk.py\", line 297, in rechunk\r\n    chunks = normalize_chunks(\r\n  File \"/Users/tom/projects-workspace/dask/dask/array/core.py\", line 2958, in normalize_chunks\r\n    raise ValueError(\r\nValueError: Chunks do not add up to shape. Got chunks=((1,), (3,)), shape=(1, 2)\r\n```\r\n\r\n**Anything else we need to know?**: there may be similar problems with `dot` and `tensordot` (needs investigation)\r\n\r\n**Environment**:\r\n\r\n- Dask version: main\r\n- Python version: 3.8\r\n- Operating System: mac\r\n- Install method (conda, pip, source): source\r\n\r\n<!-- If you are reporting an issue such as scale stability, cluster deadlock.\r\nPlease provide a cluster dump state with this issue, by running client.dump_cluster_state()\r\n\r\nhttps://distributed.dask.org/en/stable/api.html?highlight=dump_cluster_state#distributed.Client.dump_cluster_state\r\n\r\n-->\r\n\r\n<details>\r\n<summary>Cluster Dump State:</summary>\r\n\r\n</details>",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/8948/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/8948/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}