{
    "url": "https://api.github.com/repos/dask/dask/issues/10516",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/10516/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/10516/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/10516/events",
    "html_url": "https://github.com/dask/dask/issues/10516",
    "id": 1900928687,
    "node_id": "I_kwDOAbcwm85xTd6v",
    "number": 10516,
    "title": "Unexpected DataFrame map_overlap timedelta post-filtering",
    "user": {
        "login": "epizut",
        "id": 1694892,
        "node_id": "MDQ6VXNlcjE2OTQ4OTI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1694892?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/epizut",
        "html_url": "https://github.com/epizut",
        "followers_url": "https://api.github.com/users/epizut/followers",
        "following_url": "https://api.github.com/users/epizut/following{/other_user}",
        "gists_url": "https://api.github.com/users/epizut/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/epizut/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/epizut/subscriptions",
        "organizations_url": "https://api.github.com/users/epizut/orgs",
        "repos_url": "https://api.github.com/users/epizut/repos",
        "events_url": "https://api.github.com/users/epizut/events{/privacy}",
        "received_events_url": "https://api.github.com/users/epizut/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        },
        {
            "id": 3880424463,
            "node_id": "LA_kwDOAbcwm87nSpQP",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20triage",
            "name": "needs triage",
            "color": "eeeeee",
            "default": false,
            "description": "Needs a response from a contributor"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2023-09-18T13:19:58Z",
    "updated_at": "2023-10-23T01:45:38Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "The current implementation of `map_overlap()` is using a fixed number of rows to post-filter additional rows that has been added to the original partition. This behavior is incompatible with any user function that may add or delete rows.\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\ndd = dask.datasets.timeseries()\r\ndd\r\n```\r\n![image](https://github.com/dask/dask/assets/1694892/ce9a8c42-43bc-4515-87d9-3162a8715eb8)\r\n\r\n```python\r\ndef func(part):\r\n    return part.tail(1)\r\n\r\ndd.map_overlap(func, before=pd.to_timedelta('1d'), after=0).compute()\r\n# Expecting 30 rows (i.e.: 1 tail row per partition)\r\n```\r\n![image](https://github.com/dask/dask/assets/1694892/84e9bf68-da2a-447d-aadb-098128893204)\r\n\r\n\r\n\r\nBecause `before=1d` added many rows in front of every partition, the output frame is then reduced by the same number of rows, causing the user data to completely disappear except for the 1st partition where no rows were initially prepended.\r\n\r\n\r\n**Suggestion**:\r\n\r\nIn `rolling.py:overlap_chunk`, If divisions are known, then can we simply remove all data outside of the current partition index boundaries?\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2023.9.2\r\n- Python version: 3.9\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/10516/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/10516/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}