{
    "url": "https://api.github.com/repos/dask/dask/issues/7137",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/7137/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/7137/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/7137/events",
    "html_url": "https://github.com/dask/dask/issues/7137",
    "id": 796946456,
    "node_id": "MDU6SXNzdWU3OTY5NDY0NTY=",
    "number": 7137,
    "title": "HighLevelGraph.cull culling doesn't rename layers",
    "user": {
        "login": "bmerry",
        "id": 1963944,
        "node_id": "MDQ6VXNlcjE5NjM5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1963944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bmerry",
        "html_url": "https://github.com/bmerry",
        "followers_url": "https://api.github.com/users/bmerry/followers",
        "following_url": "https://api.github.com/users/bmerry/following{/other_user}",
        "gists_url": "https://api.github.com/users/bmerry/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bmerry/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bmerry/subscriptions",
        "organizations_url": "https://api.github.com/users/bmerry/orgs",
        "repos_url": "https://api.github.com/users/bmerry/repos",
        "events_url": "https://api.github.com/users/bmerry/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bmerry/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2156573524,
            "node_id": "MDU6TGFiZWwyMTU2NTczNTI0",
            "url": "https://api.github.com/repos/dask/dask/labels/highlevelgraph",
            "name": "highlevelgraph",
            "color": "8c24d6",
            "default": false,
            "description": "Issues relating to HighLevelGraphs."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 8,
    "created_at": "2021-01-29T14:55:38Z",
    "updated_at": "2021-02-26T11:22:19Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "**What happened**: when looking at the code I noticed that HighLevelGraph.cull doesn't rename layers. This can lead to problems because the layer name no longer uniquely identifies the layer. When manually optimising graphs (e.g. with the public `dask.optimize`) this can cause problems.\r\n\r\n**What you expected to happen**: Culled layers should have new names, either UUIDs or hashes that describe the new set of keys.\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\nI haven't actually stepped through the code to check that what I've described is actually the cause of this failure, but I wrote the code to trigger the condition. If it's not the cause, then I've found a bonus bug :-) The idea is that `a1` and `a2` end up with a layer with the same name but a different subset of keys, and only one copy of the layer is retained in `b`.\r\n```python\r\n#!/usr/bin/env python3\r\n\r\nimport dask.array as da\r\nimport dask\r\n\r\nwith dask.config.set({'optimization.fuse.active': False}):\r\n    a = da.from_array([1, 2], chunks=1)\r\n    a1 = a[:1]\r\n    a2 = a[1:]\r\n    (a1,) = dask.optimize(a1)\r\n    (a2,) = dask.optimize(a2)\r\n    b = a1 + a2\r\n    print(b.compute())\r\n```\r\n\r\nOutput:\r\n```\r\nTraceback (most recent call last):\r\n  File \"cull-rename.py\", line 13, in <module>\r\n    print(b.compute())\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/base.py\", line 279, in compute\r\n    (result,) = compute(self, traverse=False, **kwargs)\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/base.py\", line 561, in compute\r\n    results = schedule(dsk, keys, **kwargs)\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/threaded.py\", line 76, in get\r\n    results = get_async(\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/local.py\", line 487, in get_async\r\n    raise_exception(exc, tb)\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/local.py\", line 317, in reraise\r\n    raise exc\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/local.py\", line 222, in execute_task\r\n    result = _execute_task(task, data)\r\n  File \"/home/bmerry/work/sdp/env3/lib/python3.8/site-packages/dask/core.py\", line 121, in _execute_task\r\n    return func(*(_execute_task(a, cache) for a in args))\r\nTypeError: tuple indices must be integers or slices, not tuple\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2021.1.1\r\n- Python version: 3.8.5\r\n- Operating System: Ubuntu 20.04\r\n- Install method (conda, pip, source): pip\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/7137/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/7137/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}