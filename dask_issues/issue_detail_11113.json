{
    "url": "https://api.github.com/repos/dask/dask/issues/11113",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/11113/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/11113/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/11113/events",
    "html_url": "https://github.com/dask/dask/issues/11113",
    "id": 2287982116,
    "node_id": "I_kwDOAbcwm86IX9Yk",
    "number": 11113,
    "title": "Mean fails to compute for very large column of pyarrow type",
    "user": {
        "login": "camposandro",
        "id": 28362589,
        "node_id": "MDQ6VXNlcjI4MzYyNTg5",
        "avatar_url": "https://avatars.githubusercontent.com/u/28362589?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/camposandro",
        "html_url": "https://github.com/camposandro",
        "followers_url": "https://api.github.com/users/camposandro/followers",
        "following_url": "https://api.github.com/users/camposandro/following{/other_user}",
        "gists_url": "https://api.github.com/users/camposandro/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/camposandro/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/camposandro/subscriptions",
        "organizations_url": "https://api.github.com/users/camposandro/orgs",
        "repos_url": "https://api.github.com/users/camposandro/repos",
        "events_url": "https://api.github.com/users/camposandro/events{/privacy}",
        "received_events_url": "https://api.github.com/users/camposandro/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2024-05-09T15:52:14Z",
    "updated_at": "2024-05-14T05:00:18Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "It's not possible to calculate the grouped mean for a very large column of pyarrow type.\r\n\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\nimport pyarrow as pa\r\n\r\nimport dask.dataframe\r\nimport dask.distributed\r\n\r\ndf = pd.DataFrame({\r\n    # A series of ones that is larger than the maximum supported by uint32\r\n    'a': pd.Series(np.ones(1 << 32), dtype=pd.ArrowDtype(pa.uint8())),\r\n    # A distribution of values for which to compute the mean for\r\n    'b': pd.Series(np.linspace(0, 1, 1 << 32), dtype=pd.ArrowDtype(pa.float32())),\r\n})\r\n```\r\n\r\nIt fails to compute with the legacy DataFrame:\r\n\r\n```python\r\nwith dask.distributed.Client():\r\n    dask.dataframe.io.from_pandas(df, npartitions=5).groupby('a').b.mean().compute()\r\n```\r\n\r\n```\r\n2024-05-09 08:33:07,340 - distributed.worker - WARNING - Compute Failed\r\nKey:       ('truediv-8d00596f7743a7ba07a11eb25b3109ae', 0)\r\nFunction:  subgraph_callable-f24250c276b80c2c50dfa1c2094ebf85\r\nargs:      (a\r\n1    2.147484e+09\r\nName: b, dtype: float[pyarrow], a\r\n1    4294967296\r\nName: b, dtype: int64)\r\nkwargs:    {}\r\nException: \"ArrowInvalid('Integer value 4294967296 not in range: -16777216 to 16777216')\"\r\n```\r\n\r\nI tried using the latest DataFrame API but this operation does not seem to be supported yet:\r\n\r\n```python\r\nwith dask.distributed.Client():\r\n    dask.dataframe.from_pandas(df).groupby('a').b.mean().compute()\r\n```\r\n\r\n> NotImplementedError: <class 'pandas.core.arrays.arrow.array.ArrowExtensionArray'> does not support reshape as backed by a 1D pyarrow.ChunkedArray.\r\n\r\nPandas seems to execute this workflow without issues:\r\n\r\n```python\r\ndf.groupby('a').b.mean()\r\n```\r\n\r\n```\r\na\r\n1    0.5\r\nName: b, dtype: float[pyarrow]\r\n```\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2024.5.0\r\n- Python version: 3.10.13\r\n- Operating System: CentOS Linux 7\r\n- Install method (conda, pip, source): pip",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/11113/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/11113/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}