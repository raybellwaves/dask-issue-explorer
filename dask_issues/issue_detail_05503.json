{
    "url": "https://api.github.com/repos/dask/dask/issues/5503",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/5503/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/5503/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/5503/events",
    "html_url": "https://github.com/dask/dask/issues/5503",
    "id": 508862421,
    "node_id": "MDU6SXNzdWU1MDg4NjI0MjE=",
    "number": 5503,
    "title": "Distributing heavy functions via closures",
    "user": {
        "login": "nsmith-",
        "id": 6587412,
        "node_id": "MDQ6VXNlcjY1ODc0MTI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6587412?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nsmith-",
        "html_url": "https://github.com/nsmith-",
        "followers_url": "https://api.github.com/users/nsmith-/followers",
        "following_url": "https://api.github.com/users/nsmith-/following{/other_user}",
        "gists_url": "https://api.github.com/users/nsmith-/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/nsmith-/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/nsmith-/subscriptions",
        "organizations_url": "https://api.github.com/users/nsmith-/orgs",
        "repos_url": "https://api.github.com/users/nsmith-/repos",
        "events_url": "https://api.github.com/users/nsmith-/events{/privacy}",
        "received_events_url": "https://api.github.com/users/nsmith-/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 1342304743,
            "node_id": "MDU6TGFiZWwxMzQyMzA0NzQz",
            "url": "https://api.github.com/repos/dask/dask/labels/core",
            "name": "core",
            "color": "000000",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2019-10-18T05:28:35Z",
    "updated_at": "2021-03-12T14:37:17Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "Hi,\r\n\r\nSo I had started investigating usage of heavy functions, e.g. something with large state such as the example below:\r\n```python\r\nfrom dask.distributed import Client\r\nclient = Client()\r\n\r\nimport numpy as np\r\nimport time\r\n\r\nclass Heavy():\r\n    def __init__(self):\r\n        self.state = np.arange(1000000)\r\n    \r\n    def __call__(self, arg):\r\n        return np.sum(self.state * arg)\r\n\r\nheavy = Heavy()\r\n```\r\n\r\nIf I send jobs out using the function itself, or a small perturbation of it, it takes quite a while.  I assume there is some bottleneck in function distribution:\r\n```python\r\nfrom functools import partial\r\n\r\ndef dosomething(arg, func):\r\n    return func(arg)\r\n\r\ntic = time.time()\r\nclosure = partial(dosomething, func=heavy)\r\nout = client.map(closure, np.random.normal(size=100))\r\nsum(f.result() for f in out)\r\nprint(time.time() - tic)\r\n```\r\nreturns 21 seconds on my laptop.  Now, clearly this is a case where broadcasting could help, so I do that:\r\n```python\r\nfrom itertools import repeat\r\n\r\ndef dosomething2(args):\r\n    arg, func = args\r\n    return func(arg)\r\n\r\ntic = time.time()\r\nheavy_token = client.scatter(heavy, broadcast=True, hash=False)\r\nitems = list(zip(np.random.normal(size=100), repeat(heavy_token)))\r\nout = client.map(dosomething2, items)\r\nsum(f.result() for f in out)\r\nprint(time.time() - tic)\r\n```\r\nand that gets me down to 0.97 seconds!\r\nBut I still want to do my closure trick, so I do this:\r\n```python\r\ndef dosomething3(arg, func):\r\n    func = func.result()\r\n    return func(arg)\r\n\r\ntic = time.time()\r\nclosure = partial(dosomething3, func=heavy_token)\r\nout = client.map(closure, np.random.normal(size=100))\r\nsum(f.result() for f in out)\r\nprint(time.time() - tic)\r\n```\r\nand it takes 1.9 seconds, which seems strange that it is slower.  Now this is all fine, but the issue I want to report is that after executing the third code snippet, if I navigate to `http://127.0.0.1:8787/graph`, an exception is produced:\r\n```\r\ndistributed.utils - ERROR - '<' not supported between instances of 'NoneType' and 'tuple'\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/utils.py\", line 662, in log_errors\r\n    yield\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/dashboard/components/scheduler.py\", line 1692, in graph_doc\r\n    graph = TaskGraph(scheduler, sizing_mode=\"stretch_both\")\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/dashboard/components/scheduler.py\", line 1021, in __init__\r\n    self.layout = GraphLayout(scheduler)\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/diagnostics/graph_layout.py\", line 39, in __init__\r\n    self.scheduler, dependencies=dependencies, priority=priority\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/diagnostics/graph_layout.py\", line 43, in update_graph\r\n    stack = sorted(dependencies, key=lambda k: priority.get(k, 0), reverse=True)\r\nTypeError: '<' not supported between instances of 'NoneType' and 'tuple'\r\ntornado.application - ERROR - Uncaught exception GET /graph (127.0.0.1)\r\nHTTPServerRequest(protocol='http', host='127.0.0.1:8787', method='GET', uri='/graph', version='HTTP/1.1', remote_ip='127.0.0.1')\r\nTraceback (most recent call last):\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/web.py\", line 1592, in _execute\r\n    result = yield result\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1133, in run\r\n    value = future.result()\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1141, in run\r\n    yielded = self.gen.throw(*exc_info)\r\n  File \"/usr/local/lib/python3.7/site-packages/bokeh/server/views/doc_handler.py\", line 55, in get\r\n    session = yield self.get_session()\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1133, in run\r\n    value = future.result()\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1141, in run\r\n    yielded = self.gen.throw(*exc_info)\r\n  File \"/usr/local/lib/python3.7/site-packages/bokeh/server/views/session_handler.py\", line 77, in get_session\r\n    session = yield self.application_context.create_session_if_needed(session_id, self.request)\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1133, in run\r\n    value = future.result()\r\n  File \"/usr/local/Cellar/ipython/7.2.0/libexec/vendor/lib/python3.7/site-packages/tornado/gen.py\", line 1147, in run\r\n    yielded = self.gen.send(value)\r\n  File \"/usr/local/lib/python3.7/site-packages/bokeh/server/contexts.py\", line 215, in create_session_if_needed\r\n    self._application.initialize_document(doc)\r\n  File \"/usr/local/lib/python3.7/site-packages/bokeh/application/application.py\", line 178, in initialize_document\r\n    h.modify_document(doc)\r\n  File \"/usr/local/lib/python3.7/site-packages/bokeh/application/handlers/function.py\", line 133, in modify_document\r\n    self._func(doc)\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/dashboard/components/scheduler.py\", line 1692, in graph_doc\r\n    graph = TaskGraph(scheduler, sizing_mode=\"stretch_both\")\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/dashboard/components/scheduler.py\", line 1021, in __init__\r\n    self.layout = GraphLayout(scheduler)\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/diagnostics/graph_layout.py\", line 39, in __init__\r\n    self.scheduler, dependencies=dependencies, priority=priority\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/diagnostics/graph_layout.py\", line 43, in update_graph\r\n    stack = sorted(dependencies, key=lambda k: priority.get(k, 0), reverse=True)\r\nTypeError: '<' not supported between instances of 'NoneType' and 'tuple'\r\nException ignored in: <function TaskGraph.__del__ at 0x1125a1950>\r\nTraceback (most recent call last):\r\n  File \"/usr/local/lib/python3.7/site-packages/distributed/dashboard/components/scheduler.py\", line 1175, in __del__\r\n    self.scheduler.remove_plugin(self.layout)\r\nAttributeError: 'TaskGraph' object has no attribute 'layout'\r\n```\r\nand subsequent calls continue to produce the same error.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/5503/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/5503/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}