{
    "url": "https://api.github.com/repos/dask/dask/issues/6219",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/6219/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/6219/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/6219/events",
    "html_url": "https://github.com/dask/dask/issues/6219",
    "id": 619898853,
    "node_id": "MDU6SXNzdWU2MTk4OTg4NTM=",
    "number": 6219,
    "title": "Can't optimize HighLevelGraph (delayed object)",
    "user": {
        "login": "rabernat",
        "id": 1197350,
        "node_id": "MDQ6VXNlcjExOTczNTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1197350?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rabernat",
        "html_url": "https://github.com/rabernat",
        "followers_url": "https://api.github.com/users/rabernat/followers",
        "following_url": "https://api.github.com/users/rabernat/following{/other_user}",
        "gists_url": "https://api.github.com/users/rabernat/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/rabernat/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rabernat/subscriptions",
        "organizations_url": "https://api.github.com/users/rabernat/orgs",
        "repos_url": "https://api.github.com/users/rabernat/repos",
        "events_url": "https://api.github.com/users/rabernat/events{/privacy}",
        "received_events_url": "https://api.github.com/users/rabernat/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 2156573524,
            "node_id": "MDU6TGFiZWwyMTU2NTczNTI0",
            "url": "https://api.github.com/repos/dask/dask/labels/highlevelgraph",
            "name": "highlevelgraph",
            "color": "8c24d6",
            "default": false,
            "description": "Issues relating to HighLevelGraphs."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 13,
    "created_at": "2020-05-18T04:28:27Z",
    "updated_at": "2021-10-13T05:49:27Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "I am trying to optimize a simple read / store pipeline by fusing the read and write tasks into a single operation.\r\n\r\nHere is a concrete example:\r\n```python\r\nimport zarr\r\nimport dask\r\nimport dask.array as dsa\r\n\r\nstore_source = {}\r\nshape = (8, 8)\r\nsource_chunks = (1, 8) \r\nread_chunks = (2, 8)\r\ndtype = 'f4'\r\n\r\na_source = zarr.ones(shape, chunks=source_chunks,\r\n                     dtype=dtype, store=store_source)\r\na_source.attrs['foo'] = 'bar'\r\nd_source = dsa.from_zarr(a_source, chunks=read_chunks)\r\n\r\ntarget_store = {}\r\na_target = zarr.empty(shape, chunks=source_chunks, dtype=dtype, store=target_store)\r\na_target.attrs.update(a_source.attrs)\r\nstore_future = dsa.store(d_source, a_target, lock=False, compute=False)\r\n\r\ndask.visualize(store_future)\r\n```\r\n\r\n![image](https://user-images.githubusercontent.com/1197350/82173989-31bd5300-989d-11ea-88de-022f9501210c.png)\r\n\r\nI would like to fuse the `from-zarr` and `store` tasks into one task.\r\n\r\nHowever, I can't apply any optimizations to my graph, because of this error:\r\n```python\r\nfrom dask.optimization import fuse\r\nstore_future_opt = dask.optimize(store_future, optimizations=[fuse])\r\n```\r\nraises\r\n```\r\n---------------------------------------------------------------------------\r\nAttributeError                            Traceback (most recent call last)\r\n<ipython-input-45-3afc3be4ea23> in <module>\r\n      1 from dask.optimization import fuse\r\n----> 2 store_future_opt = dask.optimize(store_future, optimizations=[fuse])\r\n\r\n~/opt/miniconda3/envs/pangeo-py38/lib/python3.8/site-packages/dask/base.py in optimize(*args, **kwargs)\r\n    366         return args\r\n    367 \r\n--> 368     dsk = collections_to_dsk(collections, **kwargs)\r\n    369     postpersists = [\r\n    370         a.__dask_postpersist__() if is_dask_collection(a) else (None, a) for a in args\r\n\r\n~/opt/miniconda3/envs/pangeo-py38/lib/python3.8/site-packages/dask/base.py in collections_to_dsk(collections, optimize_graph, **kwargs)\r\n    212 \r\n    213         for opt in optimizations:\r\n--> 214             groups = {k: (opt(dsk, keys), keys) for k, (dsk, keys) in groups.items()}\r\n    215 \r\n    216         dsk = merge(\r\n\r\n~/opt/miniconda3/envs/pangeo-py38/lib/python3.8/site-packages/dask/base.py in <dictcomp>(.0)\r\n    212 \r\n    213         for opt in optimizations:\r\n--> 214             groups = {k: (opt(dsk, keys), keys) for k, (dsk, keys) in groups.items()}\r\n    215 \r\n    216         dsk = merge(\r\n\r\n~/opt/miniconda3/envs/pangeo-py38/lib/python3.8/site-packages/dask/optimization.py in fuse(dsk, keys, dependencies, ave_width, max_width, max_height, max_depth_new_edges, rename_keys, fuse_subgraphs)\r\n    530         return dsk, deps\r\n    531 \r\n--> 532     rv = dsk.copy()\r\n    533     fused_trees = {}\r\n    534     # These are the stacks we use to store data as we traverse the graph\r\n\r\nAttributeError: 'HighLevelGraph' object has no attribute 'copy'\r\n```\r\n\r\n(Something similar was seen in https://github.com/radix-ai/graphchain/pull/36.)\r\n\r\nAs a workaround, I tried to do the optimization on the low level graph:\r\n```python\r\ndsk_fused = fuse(store_future.dask.dicts)\r\ndask.visualize(dsk_fused)\r\n```\r\n![image](https://user-images.githubusercontent.com/1197350/82174310-3afaef80-989e-11ea-87bc-ebb2ee47f7b0.png)\r\n\r\nHowever, I don't know how to go from this back to a delayed object that I can compute. The [documentation on optimization](https://docs.dask.org/en/latest/optimize.html?highlight=fuse) does not really explain how to go back and forth between Dask's various datatypes and this low-level graph.\r\n\r\nI feel I am missing some important concept ere, but I can't figure out what.\r\n\r\nDask version 2.10.1.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/6219/reactions",
        "total_count": 1,
        "+1": 1,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/6219/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}