{
    "url": "https://api.github.com/repos/dask/dask/issues/9593",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/9593/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/9593/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/9593/events",
    "html_url": "https://github.com/dask/dask/issues/9593",
    "id": 1422909615,
    "node_id": "I_kwDOAbcwm85Uz-Cv",
    "number": 9593,
    "title": "Dataframe .loc slicing can ignore partitions",
    "user": {
        "login": "T-Flet",
        "id": 6699494,
        "node_id": "MDQ6VXNlcjY2OTk0OTQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6699494?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/T-Flet",
        "html_url": "https://github.com/T-Flet",
        "followers_url": "https://api.github.com/users/T-Flet/followers",
        "following_url": "https://api.github.com/users/T-Flet/following{/other_user}",
        "gists_url": "https://api.github.com/users/T-Flet/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/T-Flet/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/T-Flet/subscriptions",
        "organizations_url": "https://api.github.com/users/T-Flet/orgs",
        "repos_url": "https://api.github.com/users/T-Flet/repos",
        "events_url": "https://api.github.com/users/T-Flet/events{/privacy}",
        "received_events_url": "https://api.github.com/users/T-Flet/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        },
        {
            "id": 3798450413,
            "node_id": "LA_kwDOAbcwm87iZ8Dt",
            "url": "https://api.github.com/repos/dask/dask/labels/bug",
            "name": "bug",
            "color": "faadaf",
            "default": true,
            "description": "Something is broken"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 0,
    "created_at": "2022-10-25T18:38:55Z",
    "updated_at": "2024-05-06T01:46:28Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "**Behaviour**:\r\nIn some cases slicing a dataframe with .loc over the boundary between partitions results in only the last partition being considered.\r\n\r\nOne such case is the example below, in which the .loc slicing and .compute do not commute (since one .loc is dask's and one is panda's).\r\nThe source of the problem seems to be the `map_partitions` over the index, and removing the two lines converting between datetime and seconds-timestamp (marked with \"###\" at their end) makes the assertion pass (though the point is that it fails in this case).\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\nTL;DR: a dataframe is saved in two halves with an integer timestamp (of seconds) as index; the slicing issue described above occurs after reading the halves as partitions of one df and converting the index to a datetime.\r\n\r\n```python\r\nimport numpy as np\r\nimport pandas as pd\r\nimport dask.dataframe as dd\r\n\r\n## Preparing the data\r\n\r\n# Timestamps (in seconds) of minutes between two (arbitrary) timezone-aware dates\r\nminutes = pd.date_range('2021-02-02', '2022-02-02', freq = '1min', tz = 'US/Eastern')\r\nminutes = np.int64(minutes) // 10 ** 9 ### convert datetime to seconds ###\r\n\r\n# Dataframe with minutes as index and dummy columns\r\ndf = pd.DataFrame(dict(zs = np.zeros(len(minutes)), os = np.ones(len(minutes))), index = minutes)\r\n\r\n# Save in two halves\r\nhalf = int(np.floor(len(df)/2)) # Around 2021-08-03\r\ndf.iloc[:half].to_parquet('./FIRST_HALF.parquet')\r\ndf.iloc[half:].to_parquet('./SECOND_HALF.parquet')\r\n\r\n\r\n## Using the data\r\n\r\n# Read in two partitions and convert the index back to timezone-aware datetime\r\nddf = dd.read_parquet(['./FIRST_HALF.parquet', './SECOND_HALF.parquet'])\r\nddf.index = ddf.index.map_partitions(lambda index: pd.to_datetime(index, unit = 's', utc = True).tz_convert('US/Eastern')) ### convert seconds to datetime ###\r\nddf.set_index(ddf.index, sorted = True) # This line seems to need to be queued separately from the one above\r\n\r\n# One date within the first partition and one within the second\r\nfrom_date, to_date = [pd.to_datetime(date, format = '%Y-%m-%d').tz_localize('US/Eastern') for date in ('2021-06-02', '2022-01-02')]\r\n\r\n# Slicing before and after .compute\r\nddf.loc[from_date:to_date].visualize() # See the attached picture\r\ndask_loc   = ddf.loc[from_date:to_date].compute() # 2021-08-03 (half) to 2022-01-02\r\npandas_loc = ddf.compute().loc[from_date:to_date] # 2021-06-02 to 2022-01-02\r\n\r\nassert dask_loc.index.equals(pandas_loc.index), 'dask_loc ignored the first partition'\r\n```\r\n\r\nThe issue is also visible from the result of the .visualize():\r\n![mydask](https://user-images.githubusercontent.com/6699494/197851877-cb00820a-7805-46ee-bfc4-04a682f6bc1c.png)\r\n\r\n**Possibly related issues**\r\n- https://github.com/dask/dask/issues/3411\r\n- \"Issue 2\" from https://github.com/dask/dask/issues/862, though they find a work-around the specific case\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2022.5.0\r\n- Python version: 3.10.4\r\n- Operating System: Windows 10 Pro - 21H2\r\n- Install method: conda\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/9593/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/9593/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}