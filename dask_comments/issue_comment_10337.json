[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1583465136",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1583465136",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1583465136,
        "node_id": "IC_kwDOAbcwm85eYcKw",
        "user": {
            "login": "jhamman",
            "id": 2443309,
            "node_id": "MDQ6VXNlcjI0NDMzMDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2443309?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jhamman",
            "html_url": "https://github.com/jhamman",
            "followers_url": "https://api.github.com/users/jhamman/followers",
            "following_url": "https://api.github.com/users/jhamman/following{/other_user}",
            "gists_url": "https://api.github.com/users/jhamman/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jhamman/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jhamman/subscriptions",
            "organizations_url": "https://api.github.com/users/jhamman/orgs",
            "repos_url": "https://api.github.com/users/jhamman/repos",
            "events_url": "https://api.github.com/users/jhamman/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jhamman/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-08T22:22:18Z",
        "updated_at": "2023-06-08T22:22:18Z",
        "author_association": "MEMBER",
        "body": "pinging the @dask/array crew for \ud83d\udc40 on this one.",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1583465136/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1583607799",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1583607799",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1583607799,
        "node_id": "IC_kwDOAbcwm85eY-_3",
        "user": {
            "login": "jrbourbeau",
            "id": 11656932,
            "node_id": "MDQ6VXNlcjExNjU2OTMy",
            "avatar_url": "https://avatars.githubusercontent.com/u/11656932?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jrbourbeau",
            "html_url": "https://github.com/jrbourbeau",
            "followers_url": "https://api.github.com/users/jrbourbeau/followers",
            "following_url": "https://api.github.com/users/jrbourbeau/following{/other_user}",
            "gists_url": "https://api.github.com/users/jrbourbeau/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jrbourbeau/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jrbourbeau/subscriptions",
            "organizations_url": "https://api.github.com/users/jrbourbeau/orgs",
            "repos_url": "https://api.github.com/users/jrbourbeau/repos",
            "events_url": "https://api.github.com/users/jrbourbeau/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jrbourbeau/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-08T23:41:18Z",
        "updated_at": "2023-06-08T23:41:18Z",
        "author_association": "MEMBER",
        "body": "Thanks @jhamman! @crusaderky is this something you have bandwidth to look into? ",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1583607799/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1585002818",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1585002818",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1585002818,
        "node_id": "IC_kwDOAbcwm85eeTlC",
        "user": {
            "login": "crusaderky",
            "id": 6213168,
            "node_id": "MDQ6VXNlcjYyMTMxNjg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6213168?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/crusaderky",
            "html_url": "https://github.com/crusaderky",
            "followers_url": "https://api.github.com/users/crusaderky/followers",
            "following_url": "https://api.github.com/users/crusaderky/following{/other_user}",
            "gists_url": "https://api.github.com/users/crusaderky/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/crusaderky/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/crusaderky/subscriptions",
            "organizations_url": "https://api.github.com/users/crusaderky/orgs",
            "repos_url": "https://api.github.com/users/crusaderky/repos",
            "events_url": "https://api.github.com/users/crusaderky/events{/privacy}",
            "received_events_url": "https://api.github.com/users/crusaderky/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-09T18:49:35Z",
        "updated_at": "2023-06-09T18:49:35Z",
        "author_association": "MEMBER",
        "body": "Yes, I can look into it early next week",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1585002818/reactions",
            "total_count": 2,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 2,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1585149125",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1585149125",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1585149125,
        "node_id": "IC_kwDOAbcwm85ee3TF",
        "user": {
            "login": "jrbourbeau",
            "id": 11656932,
            "node_id": "MDQ6VXNlcjExNjU2OTMy",
            "avatar_url": "https://avatars.githubusercontent.com/u/11656932?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jrbourbeau",
            "html_url": "https://github.com/jrbourbeau",
            "followers_url": "https://api.github.com/users/jrbourbeau/followers",
            "following_url": "https://api.github.com/users/jrbourbeau/following{/other_user}",
            "gists_url": "https://api.github.com/users/jrbourbeau/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jrbourbeau/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jrbourbeau/subscriptions",
            "organizations_url": "https://api.github.com/users/jrbourbeau/orgs",
            "repos_url": "https://api.github.com/users/jrbourbeau/repos",
            "events_url": "https://api.github.com/users/jrbourbeau/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jrbourbeau/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-09T21:33:50Z",
        "updated_at": "2023-06-09T21:33:50Z",
        "author_association": "MEMBER",
        "body": "Sounds great, thanks as always @crusaderky ",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1585149125/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1587178127",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1587178127",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1587178127,
        "node_id": "IC_kwDOAbcwm85emmqP",
        "user": {
            "login": "crusaderky",
            "id": 6213168,
            "node_id": "MDQ6VXNlcjYyMTMxNjg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6213168?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/crusaderky",
            "html_url": "https://github.com/crusaderky",
            "followers_url": "https://api.github.com/users/crusaderky/followers",
            "following_url": "https://api.github.com/users/crusaderky/following{/other_user}",
            "gists_url": "https://api.github.com/users/crusaderky/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/crusaderky/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/crusaderky/subscriptions",
            "organizations_url": "https://api.github.com/users/crusaderky/orgs",
            "repos_url": "https://api.github.com/users/crusaderky/repos",
            "events_url": "https://api.github.com/users/crusaderky/events{/privacy}",
            "received_events_url": "https://api.github.com/users/crusaderky/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-12T11:53:11Z",
        "updated_at": "2023-06-12T11:53:11Z",
        "author_association": "MEMBER",
        "body": "@jhamman \r\nI can't reproduce the issue. I ran your code and I'm observing a peak memory usage of 4 x chunk size x threads, which does not increase as time passes.\r\nYour test data (247 MiB per chunk) on my cluster with 4 threads per worker peaks at 3.9 GiB process memory per worker.\r\n\r\nTested on\r\ndask 2023.6.0 as well as 2023.5.0\r\nzarr 2.14.2\r\n\r\nAre you sure that you're not omitting something in your reproducer? The behaviour you're describing makes me think that something else is holding a reference to `arr`.\r\nFor example, this will reproduce your behaviour:\r\n```python\r\nstate = da.random.RandomState(1234)\r\narr = state.random((500, 17999, 36000), chunks=(5, 1799, 3600))\r\narr = arr.persist()\r\narr.to_zarr(store, component='compute_true', compute=True)\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1587178127/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1587189694",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1587189694",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1587189694,
        "node_id": "IC_kwDOAbcwm85empe-",
        "user": {
            "login": "crusaderky",
            "id": 6213168,
            "node_id": "MDQ6VXNlcjYyMTMxNjg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6213168?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/crusaderky",
            "html_url": "https://github.com/crusaderky",
            "followers_url": "https://api.github.com/users/crusaderky/followers",
            "following_url": "https://api.github.com/users/crusaderky/following{/other_user}",
            "gists_url": "https://api.github.com/users/crusaderky/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/crusaderky/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/crusaderky/subscriptions",
            "organizations_url": "https://api.github.com/users/crusaderky/orgs",
            "repos_url": "https://api.github.com/users/crusaderky/repos",
            "events_url": "https://api.github.com/users/crusaderky/events{/privacy}",
            "received_events_url": "https://api.github.com/users/crusaderky/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-12T11:59:19Z",
        "updated_at": "2023-06-12T11:59:19Z",
        "author_association": "MEMBER",
        "body": "Another possibility is that `zarr.core.Array.__setitem__(idx, item)` internally preserves a reference to `item` and never releases it. Are you using an old version of zarr?",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1587189694/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1587494577",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1587494577",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1587494577,
        "node_id": "IC_kwDOAbcwm85enz6x",
        "user": {
            "login": "jhamman",
            "id": 2443309,
            "node_id": "MDQ6VXNlcjI0NDMzMDk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2443309?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jhamman",
            "html_url": "https://github.com/jhamman",
            "followers_url": "https://api.github.com/users/jhamman/followers",
            "following_url": "https://api.github.com/users/jhamman/following{/other_user}",
            "gists_url": "https://api.github.com/users/jhamman/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jhamman/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jhamman/subscriptions",
            "organizations_url": "https://api.github.com/users/jhamman/orgs",
            "repos_url": "https://api.github.com/users/jhamman/repos",
            "events_url": "https://api.github.com/users/jhamman/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jhamman/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-12T14:45:33Z",
        "updated_at": "2023-06-12T14:45:33Z",
        "author_association": "MEMBER",
        "body": "@crusaderky - My example above swapped out a custom Zarr store with the FSSpec store so I'm not entirely surprised they behave differently. I'm working toward an example that includes the custom store but getting a minimal reproducer with it is non-trivial.\r\n\r\nMy main question in this issue is how/why are is the graph/execution different when compute is True vs False. Can you help unpack that more narrow question without a reproducer? ",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1587494577/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1587600039",
        "html_url": "https://github.com/dask/dask/issues/10337#issuecomment-1587600039",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/10337",
        "id": 1587600039,
        "node_id": "IC_kwDOAbcwm85eoNqn",
        "user": {
            "login": "crusaderky",
            "id": 6213168,
            "node_id": "MDQ6VXNlcjYyMTMxNjg=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6213168?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/crusaderky",
            "html_url": "https://github.com/crusaderky",
            "followers_url": "https://api.github.com/users/crusaderky/followers",
            "following_url": "https://api.github.com/users/crusaderky/following{/other_user}",
            "gists_url": "https://api.github.com/users/crusaderky/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/crusaderky/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/crusaderky/subscriptions",
            "organizations_url": "https://api.github.com/users/crusaderky/orgs",
            "repos_url": "https://api.github.com/users/crusaderky/repos",
            "events_url": "https://api.github.com/users/crusaderky/events{/privacy}",
            "received_events_url": "https://api.github.com/users/crusaderky/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2023-06-12T15:46:10Z",
        "updated_at": "2023-06-12T15:46:10Z",
        "author_association": "MEMBER",
        "body": "I am unsure what's the difference between compute=True and False. On paper, they both should behave in the same way, with the only difference that the final collection of the `store-map` outputs (a bunch of None's) happens on the client and on a worker running a dummy Delayed respectively. The timing of this final transfer should be identical in both cases.\r\n\r\nAre you sure your `return_stored` flag is set to False? On return_stored=True compute=True, data will be read back from disk and persisted - resulting in the behaviour you are seeing.\r\n\r\nIn your bokeh GUI, could you look at the task counts?\r\n![image](https://github.com/dask/dask/assets/6213168/1265d23b-2dad-4a6d-b5f8-017e6fd6bd17)\r\nIf you hover on either bar, you should read an ever-increasing number of tasks in memory for 'store-map' (they are just None's) and a very small number of tasks in memory for 'random-sample' (capped to your cluster-wide threads).\r\n\r\nThere should be no other tasks. Replace `random-sample` with what you are actually using to generate the data; the key point must remain however that you should not have more than ~nthreads worth of those tasks in memory at any one time.\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1587600039/reactions",
            "total_count": 1,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 1
        },
        "performed_via_github_app": null
    }
]