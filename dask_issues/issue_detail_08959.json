{
    "url": "https://api.github.com/repos/dask/dask/issues/8959",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/8959/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/8959/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/8959/events",
    "html_url": "https://github.com/dask/dask/issues/8959",
    "id": 1210155003,
    "node_id": "I_kwDOAbcwm85IIX_7",
    "number": 8959,
    "title": "DataFrame groupby+apply/transform/shift on index results in unwanted shuffle",
    "user": {
        "login": "ian-r-rose",
        "id": 5728311,
        "node_id": "MDQ6VXNlcjU3MjgzMTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5728311?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ian-r-rose",
        "html_url": "https://github.com/ian-r-rose",
        "followers_url": "https://api.github.com/users/ian-r-rose/followers",
        "following_url": "https://api.github.com/users/ian-r-rose/following{/other_user}",
        "gists_url": "https://api.github.com/users/ian-r-rose/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ian-r-rose/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ian-r-rose/subscriptions",
        "organizations_url": "https://api.github.com/users/ian-r-rose/orgs",
        "repos_url": "https://api.github.com/users/ian-r-rose/repos",
        "events_url": "https://api.github.com/users/ian-r-rose/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ian-r-rose/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        },
        {
            "id": 3798450413,
            "node_id": "LA_kwDOAbcwm87iZ8Dt",
            "url": "https://api.github.com/repos/dask/dask/labels/bug",
            "name": "bug",
            "color": "faadaf",
            "default": true,
            "description": "Something is broken"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2022-04-20T20:02:11Z",
    "updated_at": "2022-05-23T02:11:37Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "**What happened**:\r\n\r\nI'm working on pandas 1.5 compatibility (cf #8776) and came across this apparent bug in groupby + transform/apply/shift.\r\nIf we are grouping on the dataframe index, we should be able to avoid a shuffle, since the dataframe is already ordered in the way we want. Indeed, the groupby code has a check to avoid shuffling: \r\nhttps://github.com/dask/dask/blob/99e260081f51ce368bf0456c66c9d3c2f20e8c9b/dask/dataframe/groupby.py#L1724\r\n\r\nHowever, this check does not succeed when you pass in the dask dataframe index directly, as the check only looks for column names.\r\n\r\nI think we can fix this by also checking if the `dd.Index` *dask* name matches the grouped-by object's name (pseudocode, since `by` could be a string):\r\n\r\n```python\r\n should_shuffle = not (\r\n    df.known_divisions and\r\n    (df._contains_index_name(self.by) or df.index._name == self.by._name)\r\n) \r\n```\r\n**What you expected to happen**:\r\n\r\nGrouping by `ddf.index` should avoid a shuffle.\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\nimport dask\r\nimport dask.dataframe as dd\r\nimport pandas\r\n\r\n# use task-based rather than disk based for easier introspection.\r\n# Not otherwise important here\r\ndask.config.set({\"shuffle\": \"tasks\"})\r\n\r\ndf = pandas.DataFrame(\r\n    {\"x\": [1, 2, 3, 4]},\r\n    index=pandas.Index([\"a\", \"a\", \"b\", \"b\"], name=\"idx\"),\r\n)\r\nddf = dd.from_pandas(df, npartitions=2)\r\n\r\n# Groupby index name avoids shuffle\r\nddf = ddf.groupby(\"idx\").apply(lambda x: x, meta=ddf._meta)\r\nassert not any(isinstance(l, dask.layers.SimpleShuffleLayer) for l in ddf.dask.layers.values())\r\n\r\n# Groupby index object shuffles!\r\nddf = ddf.groupby(ddf.index).apply(lambda x: x, meta=ddf._meta)\r\nassert not any(isinstance(l, dask.layers.SimpleShuffleLayer) for l in ddf.dask.layers.values())\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\n**Environment**:\r\n\r\n- Dask version: `main`\r\n- Python version: 3.8\r\n- Operating System: ubuntu\r\n- Install method (conda, pip, source): source",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/8959/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/8959/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}