{
    "url": "https://api.github.com/repos/dask/dask/issues/8813",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/8813/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/8813/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/8813/events",
    "html_url": "https://github.com/dask/dask/issues/8813",
    "id": 1170070214,
    "node_id": "I_kwDOAbcwm85FvdrG",
    "number": 8813,
    "title": "Some `dt` accessor methods applied to an Index may result in invalid divisions",
    "user": {
        "login": "jcrist",
        "id": 2783717,
        "node_id": "MDQ6VXNlcjI3ODM3MTc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2783717?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jcrist",
        "html_url": "https://github.com/jcrist",
        "followers_url": "https://api.github.com/users/jcrist/followers",
        "following_url": "https://api.github.com/users/jcrist/following{/other_user}",
        "gists_url": "https://api.github.com/users/jcrist/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jcrist/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jcrist/subscriptions",
        "organizations_url": "https://api.github.com/users/jcrist/orgs",
        "repos_url": "https://api.github.com/users/jcrist/repos",
        "events_url": "https://api.github.com/users/jcrist/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jcrist/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2022-03-15T19:02:54Z",
    "updated_at": "2022-03-16T16:25:07Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "Specifically, I found that `index.dt.floor(...)` can result in invalid divisions if the divisions already align with the period passed to floor. For example:\r\n\r\n```python\r\nimport dask.dataframe as dd\r\nimport pandas as pd\r\n\r\ndate_index = pd.date_range(start=\"2022-02-22\", freq=\"16h\", periods=12)\r\ndf = pd.Series(range(12), index=date_index)\r\nddf = dd.from_pandas(df, npartitions=3)\r\n\r\nres = ddf.index.dt.floor(\"D\")\r\nsol = df.index.floor(\"D\")\r\n\r\ndd.assert_eq(res, sol)\r\n```\r\n\r\nResults in \r\n\r\n```python-traceback\r\nTraceback (most recent call last):\r\n  File \"/home/jcristharif/Code/dask/test.py\", line 11, in <module>\r\n    dd.assert_eq(res, sol)\r\n  File \"/home/jcristharif/Code/dask/dask/dataframe/utils.py\", line 537, in assert_eq\r\n    assert_divisions(a, scheduler=scheduler)\r\n  File \"/home/jcristharif/Code/dask/dask/dataframe/utils.py\", line 616, in assert_divisions\r\n    assert index(df).max() < ddf.divisions[i + 1]\r\nAssertionError\r\n```\r\n\r\nThis error indicates that the max of a partition isn't less than the upper bound for that partition as stated by the divisions. This is because the divisions were adjusted by `map_partitions` (with `.floor(\"D\")` applied), and that adjustment is non-linear (multiple values all mapped to the same output). `ceil` is also broken for the same reason, and there may be other `dt` methods with the same issue.\r\n\r\nAction items:\r\n\r\n- [ ] Special case `ceil` & `floor` methods in the `DatetimeAccessor` class to properly adjust the divisions given an `Index` with known divisions\r\n- [ ] Evaluate other `dt` methods for similar bugs, and fix those as well (or create specific issues for them as found)\r\n- [ ] Improve our test coverage for the `DatetimeAccessor`, covering both `Series.dt` and `Index.dt` (with known and unknown divisions).",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/8813/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/8813/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}