[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1294186052",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1294186052",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1294186052,
        "node_id": "IC_kwDOAbcwm85NI7ZE",
        "user": {
            "login": "ncclementi",
            "id": 7526622,
            "node_id": "MDQ6VXNlcjc1MjY2MjI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7526622?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ncclementi",
            "html_url": "https://github.com/ncclementi",
            "followers_url": "https://api.github.com/users/ncclementi/followers",
            "following_url": "https://api.github.com/users/ncclementi/following{/other_user}",
            "gists_url": "https://api.github.com/users/ncclementi/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ncclementi/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ncclementi/subscriptions",
            "organizations_url": "https://api.github.com/users/ncclementi/orgs",
            "repos_url": "https://api.github.com/users/ncclementi/repos",
            "events_url": "https://api.github.com/users/ncclementi/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ncclementi/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-27T22:26:52Z",
        "updated_at": "2022-10-27T22:26:52Z",
        "author_association": "MEMBER",
        "body": "Ok, I was able to get the test working, but I had to pass storage options to `text_blocks_to_pandas` to be able to check the filesystem. \r\n\r\nWe (with @ian-r-rose ) try to annotate the tasks in `read_bytes` where we do have storage options and a file system, but the annotations where lost along the way. \r\n\r\nAdding storage options to `text_blocks_to_pandas` is breaking other tests because I'm not passing it into those tests, I want to make sure there is no way around this before I start touching all the other tests. \r\n\r\n@jrbourbeau do you have any thoughts? ",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1294186052/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1295362533",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1295362533",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1295362533,
        "node_id": "IC_kwDOAbcwm85NNanl",
        "user": {
            "login": "mrocklin",
            "id": 306380,
            "node_id": "MDQ6VXNlcjMwNjM4MA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/306380?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrocklin",
            "html_url": "https://github.com/mrocklin",
            "followers_url": "https://api.github.com/users/mrocklin/followers",
            "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
            "organizations_url": "https://api.github.com/users/mrocklin/orgs",
            "repos_url": "https://api.github.com/users/mrocklin/repos",
            "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrocklin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-28T19:14:29Z",
        "updated_at": "2022-10-28T19:14:29Z",
        "author_association": "MEMBER",
        "body": "> We (with @ian-r-rose ) try to annotate the tasks in read_bytes where we do have storage options and a file system, but the annotations where lost along the way.\r\n\r\nCan I ask for more information on this?  This feels like the right approach if we can make it work.  Otherwise I'm afraid that we'll have ten PRs like this one over time.\r\n\r\nTotally ok if that's really hard and doing this singly on read_csv is a bandaid.  I'd like to at least record the effort and elevate whatever issues we ran into though.",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1295362533/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1295474008",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1295474008",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1295474008,
        "node_id": "IC_kwDOAbcwm85NN11Y",
        "user": {
            "login": "ncclementi",
            "id": 7526622,
            "node_id": "MDQ6VXNlcjc1MjY2MjI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7526622?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ncclementi",
            "html_url": "https://github.com/ncclementi",
            "followers_url": "https://api.github.com/users/ncclementi/followers",
            "following_url": "https://api.github.com/users/ncclementi/following{/other_user}",
            "gists_url": "https://api.github.com/users/ncclementi/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ncclementi/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ncclementi/subscriptions",
            "organizations_url": "https://api.github.com/users/ncclementi/orgs",
            "repos_url": "https://api.github.com/users/ncclementi/repos",
            "events_url": "https://api.github.com/users/ncclementi/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ncclementi/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-28T21:14:29Z",
        "updated_at": "2022-10-28T21:14:29Z",
        "author_association": "MEMBER",
        "body": "> > We (with @ian-r-rose ) try to annotate the tasks in read_bytes where we do have storage options and a file system, but the annotations were lost along the way.\r\n> Can I ask for more information on this? This feels like the right approach if we can make it work. Otherwise I'm afraid that we'll have ten PRs like this one over time.\r\n \r\nLong story short, when we implemented the annotations on `read_bytes`, and trying to run this portion of the test, \r\n```python\r\n    ddf2 = dd.read_csv(f\"{remote_fn}/*.part\", storage_options=storage_options)\r\n    layer = hlg_layer(ddf2.dask, \"read-csv\")\r\n    assert layer.annotations\r\n    assert layer.annotations[\"retries\"] == 5\r\n```\r\nThere were no annotations. We know that the annotations were created on read_bytes because we checked with breakpoints at that level. @ian-r-rose Is there anything I'm forgetting? \r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1295474008/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1295569506",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1295569506",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1295569506,
        "node_id": "IC_kwDOAbcwm85NONJi",
        "user": {
            "login": "mrocklin",
            "id": 306380,
            "node_id": "MDQ6VXNlcjMwNjM4MA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/306380?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrocklin",
            "html_url": "https://github.com/mrocklin",
            "followers_url": "https://api.github.com/users/mrocklin/followers",
            "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
            "organizations_url": "https://api.github.com/users/mrocklin/orgs",
            "repos_url": "https://api.github.com/users/mrocklin/repos",
            "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrocklin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-28T22:34:16Z",
        "updated_at": "2022-10-28T22:34:16Z",
        "author_association": "MEMBER",
        "body": "Great.  Can I ask that we surface that as an issue for future tracking?  I\nwouldn't want the only record of that to be on this PR.\n\nAlternatively, perhaps we don't close the linked issue and report this\nconversation on that issue.\n\nOn Fri, Oct 28, 2022 at 4:14 PM Naty Clementi ***@***.***>\nwrote:\n\n> We (with @ian-r-rose <https://github.com/ian-r-rose> ) try to annotate\n> the tasks in read_bytes where we do have storage options and a file system,\n> but the annotations were lost along the way.\n> Can I ask for more information on this? This feels like the right approach\n> if we can make it work. Otherwise I'm afraid that we'll have ten PRs like\n> this one over time.\n>\n> Long story short, when we implemented the annotations on read_bytes, and\n> trying to run this portion of the test,\n>\n>     ddf2 = dd.read_csv(f\"{remote_fn}/*.part\", storage_options=storage_options)\n>     layer = hlg_layer(ddf2.dask, \"read-csv\")\n>     assert layer.annotations\n>     assert layer.annotations[\"retries\"] == 5\n>\n> There were no annotations. We know that the annotations were created on\n> read_bytes because we checked with breakpoints at that level. @ian-r-rose\n> <https://github.com/ian-r-rose> Is there anything I'm forgetting?\n>\n> \u2014\n> Reply to this email directly, view it on GitHub\n> <https://github.com/dask/dask/pull/9601#issuecomment-1295474008>, or\n> unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AACKZTAL7DMK7K5CCXKJWRLWFQ637ANCNFSM6AAAAAARQFS2V4>\n> .\n> You are receiving this because you commented.Message ID:\n> ***@***.***>\n>\n",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1295569506/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1304141674",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1304141674",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1304141674,
        "node_id": "IC_kwDOAbcwm85Nu59q",
        "user": {
            "login": "ian-r-rose",
            "id": 5728311,
            "node_id": "MDQ6VXNlcjU3MjgzMTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5728311?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ian-r-rose",
            "html_url": "https://github.com/ian-r-rose",
            "followers_url": "https://api.github.com/users/ian-r-rose/followers",
            "following_url": "https://api.github.com/users/ian-r-rose/following{/other_user}",
            "gists_url": "https://api.github.com/users/ian-r-rose/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ian-r-rose/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ian-r-rose/subscriptions",
            "organizations_url": "https://api.github.com/users/ian-r-rose/orgs",
            "repos_url": "https://api.github.com/users/ian-r-rose/repos",
            "events_url": "https://api.github.com/users/ian-r-rose/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ian-r-rose/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-11-04T20:11:55Z",
        "updated_at": "2022-11-04T20:11:55Z",
        "author_association": "MEMBER",
        "body": "> > We (with @ian-r-rose ) try to annotate the tasks in read_bytes where we do have storage options and a file system, but the annotations where lost along the way.\r\n> \r\n> Can I ask for more information on this? This feels like the right approach if we can make it work. Otherwise I'm afraid that we'll have ten PRs like this one over time.\r\n> \r\n> Totally ok if that's really hard and doing this singly on read_csv is a bandaid. I'd like to at least record the effort and elevate whatever issues we ran into though.\r\n\r\nA bit more detail into what's going on here, so others don't have to trace through the same steps:\r\n\r\n`dask.bytes.core.read_bytes()` produces an iterable of `Delayed`s, for which the backing dsk can be annotated with things like `retries`:\r\n\r\nhttps://github.com/dask/dask/blob/6cf569376584c92ef36c677e395bcebbe620cdfc/dask/bytes/core.py#L146-L159\r\n\r\n*However*, that is not the end of the story for `read_csv`. After `read_bytes` creates it's delayed objects, `read_csv` *manually unpacks them into a low-level graph. In so doing, whatever annotations you might have placed on the delayed objects are lost (since annotations only exist on high level graphs):\r\n\r\nhttps://github.com/dask/dask/blob/6cf569376584c92ef36c677e395bcebbe620cdfc/dask/dataframe/io/csv.py#L651-L664\r\n\r\nThe upshot here, is that in lieu of a major refactor, the appropriate place to set these annotations is around the `from_map` call, which creates the blockwise layer that actually comes out of `read_csv`. So this will work for things like `read_table` and `read_fwf`, but not things that take other paths like `avro`, `json`, or `db.read_text()`.",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1304141674/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1335959388",
        "html_url": "https://github.com/dask/dask/pull/9601#issuecomment-1335959388",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9601",
        "id": 1335959388,
        "node_id": "IC_kwDOAbcwm85PoR9c",
        "user": {
            "login": "ncclementi",
            "id": 7526622,
            "node_id": "MDQ6VXNlcjc1MjY2MjI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7526622?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ncclementi",
            "html_url": "https://github.com/ncclementi",
            "followers_url": "https://api.github.com/users/ncclementi/followers",
            "following_url": "https://api.github.com/users/ncclementi/following{/other_user}",
            "gists_url": "https://api.github.com/users/ncclementi/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ncclementi/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ncclementi/subscriptions",
            "organizations_url": "https://api.github.com/users/ncclementi/orgs",
            "repos_url": "https://api.github.com/users/ncclementi/repos",
            "events_url": "https://api.github.com/users/ncclementi/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ncclementi/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-12-02T23:33:06Z",
        "updated_at": "2022-12-02T23:33:06Z",
        "author_association": "MEMBER",
        "body": "Current status:\r\n- The fix will only work for `read_csv`, it will imply modifying some tests that are failing because. I had to pass storage options to text_blocks_to_pandas to be able to check the filesystem. Is this the route we want to take?\r\n- Reason why annotations on read_bytes does not work, https://github.com/dask/dask/pull/9601/#issuecomment-1304141674\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1335959388/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]