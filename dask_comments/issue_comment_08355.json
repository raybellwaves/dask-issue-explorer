[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/964560347",
        "html_url": "https://github.com/dask/dask/issues/8355#issuecomment-964560347",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8355",
        "id": 964560347,
        "node_id": "IC_kwDOAbcwm845fgXb",
        "user": {
            "login": "jrbourbeau",
            "id": 11656932,
            "node_id": "MDQ6VXNlcjExNjU2OTMy",
            "avatar_url": "https://avatars.githubusercontent.com/u/11656932?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jrbourbeau",
            "html_url": "https://github.com/jrbourbeau",
            "followers_url": "https://api.github.com/users/jrbourbeau/followers",
            "following_url": "https://api.github.com/users/jrbourbeau/following{/other_user}",
            "gists_url": "https://api.github.com/users/jrbourbeau/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jrbourbeau/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jrbourbeau/subscriptions",
            "organizations_url": "https://api.github.com/users/jrbourbeau/orgs",
            "repos_url": "https://api.github.com/users/jrbourbeau/repos",
            "events_url": "https://api.github.com/users/jrbourbeau/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jrbourbeau/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-09T21:23:30Z",
        "updated_at": "2021-11-09T21:23:30Z",
        "author_association": "MEMBER",
        "body": "Thanks for reporting and providing a nice, minimal code snippet @aloysius-lim. I tried the example listed in the \"Minimal Complete Verifiable Example\" section, but am not able to reproduce the error you're seeing.\r\n\r\nWhat version of NumPy are you using? It looks like you may be running into https://github.com/dask/dask/issues/7170 which, I think, was fixed upstream in NumPy (for reference, I'm not able to reproduce using the latest `numpy==`1.21.4` release)",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/964560347/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/964874742",
        "html_url": "https://github.com/dask/dask/issues/8355#issuecomment-964874742",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8355",
        "id": 964874742,
        "node_id": "IC_kwDOAbcwm845gtH2",
        "user": {
            "login": "aloysius-lim",
            "id": 3433970,
            "node_id": "MDQ6VXNlcjM0MzM5NzA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3433970?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aloysius-lim",
            "html_url": "https://github.com/aloysius-lim",
            "followers_url": "https://api.github.com/users/aloysius-lim/followers",
            "following_url": "https://api.github.com/users/aloysius-lim/following{/other_user}",
            "gists_url": "https://api.github.com/users/aloysius-lim/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aloysius-lim/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aloysius-lim/subscriptions",
            "organizations_url": "https://api.github.com/users/aloysius-lim/orgs",
            "repos_url": "https://api.github.com/users/aloysius-lim/repos",
            "events_url": "https://api.github.com/users/aloysius-lim/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aloysius-lim/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-10T08:04:56Z",
        "updated_at": "2021-11-10T08:04:56Z",
        "author_association": "NONE",
        "body": "@jrbourbeau you're right, I was using numpy 1.21.3, and updating it to 1.21.4 seemed to solve the problem... at first. The problem appeared again in our unit test suite.\r\n\r\nOn further investigation, I found a strange behavior where the first invocation of `reset_index()` succeeds, but any subsequent calls (even on different data frames) produces the same \"could not deserialize task\" error.\r\n\r\nWhat I tried:\r\n\r\nRepeat the same operation on the same dataframe.\r\n\r\n```python\r\nfrom dask.distributed import Client\r\nimport dask.dataframe as dd\r\nimport pandas as pd\r\n\r\nclient = Client()\r\n\r\ndf = pd.DataFrame({\r\n    \"id\": pd.Series(dtype=\"str\"),\r\n    \"data\": pd.Series(dtype=\"int\")\r\n})\r\n\r\n# No error\r\nddf = dd.from_pandas(df, npartitions=1)\r\nddf.set_index(\"id\", npartitions=\"auto\")\r\n\r\n# Error\r\nddf.set_index(\"id\", npartitions=\"auto\")\r\n```\r\n\r\nSame steps, on a different dataframe.\r\n\r\n```python\r\nfrom dask.distributed import Client\r\nimport dask.dataframe as dd\r\nimport pandas as pd\r\n\r\nclient = Client()\r\n\r\ndf = pd.DataFrame({\r\n    \"id\": pd.Series(dtype=\"str\"),\r\n    \"data\": pd.Series(dtype=\"int\")\r\n})\r\n\r\ndf2 = pd.DataFrame({\r\n    \"id\": pd.Series(dtype=\"str\"),\r\n    \"data\": pd.Series(dtype=\"int\")\r\n})\r\n\r\n# No error\r\nddf = dd.from_pandas(df, npartitions=1)\r\nddf.set_index(\"id\", npartitions=\"auto\")\r\n\r\n# Error\r\nddf2 = dd.from_pandas(df2, npartitions=1)\r\nddf2.set_index(\"id\", npartitions=\"auto\")\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/964874742/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/972122333",
        "html_url": "https://github.com/dask/dask/issues/8355#issuecomment-972122333",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8355",
        "id": 972122333,
        "node_id": "IC_kwDOAbcwm8458Wjd",
        "user": {
            "login": "ian-r-rose",
            "id": 5728311,
            "node_id": "MDQ6VXNlcjU3MjgzMTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5728311?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ian-r-rose",
            "html_url": "https://github.com/ian-r-rose",
            "followers_url": "https://api.github.com/users/ian-r-rose/followers",
            "following_url": "https://api.github.com/users/ian-r-rose/following{/other_user}",
            "gists_url": "https://api.github.com/users/ian-r-rose/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ian-r-rose/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ian-r-rose/subscriptions",
            "organizations_url": "https://api.github.com/users/ian-r-rose/orgs",
            "repos_url": "https://api.github.com/users/ian-r-rose/repos",
            "events_url": "https://api.github.com/users/ian-r-rose/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ian-r-rose/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-17T22:04:11Z",
        "updated_at": "2021-11-17T22:04:11Z",
        "author_association": "MEMBER",
        "body": "Hi @aloysius-lim , thanks for the update.\r\n\r\nI was able to reproduce your issue on using numpy==1.21.4, so it seems the underlying problem in #7170 is not fully resolved.\r\nOf note: the error seems to be coming from deserializing cached values, so it makes sense that it would only crop up on the *second* time you are executing `set_index()`:\r\n\r\n```python-traceback\r\ndistributed.worker - ERROR - Could not deserialize task\r\nTraceback (most recent call last):\r\n  File \"/home/ian/dask/distributed/distributed/worker.py\", line 4121, in loads_function\r\n    result = cache_loads[bytes_object]\r\n  File \"/home/ian/dask/distributed/distributed/utils.py\", line 1363, in __getitem__\r\n    value = super().__getitem__(key)\r\n  File \"/home/ian/miniconda3/envs/dask/lib/python3.8/collections/__init__.py\", line 1010, in __getitem__\r\n    raise KeyError(key)\r\nKeyError: b'\\x80\\x04\\x95R\\x13\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x11dask.optimization\\x94\\x8c\\x10SubgraphCallable\\\r\n...\r\n```\r\n\r\nWe'll do some more digging to see what's going on",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/972122333/reactions",
            "total_count": 1,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1227561872",
        "html_url": "https://github.com/dask/dask/issues/8355#issuecomment-1227561872",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8355",
        "id": 1227561872,
        "node_id": "IC_kwDOAbcwm85JKxuQ",
        "user": {
            "login": "ian-r-rose",
            "id": 5728311,
            "node_id": "MDQ6VXNlcjU3MjgzMTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5728311?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ian-r-rose",
            "html_url": "https://github.com/ian-r-rose",
            "followers_url": "https://api.github.com/users/ian-r-rose/followers",
            "following_url": "https://api.github.com/users/ian-r-rose/following{/other_user}",
            "gists_url": "https://api.github.com/users/ian-r-rose/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ian-r-rose/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ian-r-rose/subscriptions",
            "organizations_url": "https://api.github.com/users/ian-r-rose/orgs",
            "repos_url": "https://api.github.com/users/ian-r-rose/repos",
            "events_url": "https://api.github.com/users/ian-r-rose/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ian-r-rose/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-08-25T17:27:49Z",
        "updated_at": "2022-08-25T17:27:49Z",
        "author_association": "MEMBER",
        "body": "Update here: @pavithraes and I took another look at it, and it still reproduces with `distributed==2022.8.1` and `numpy==1.23.1`",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1227561872/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1247157094",
        "html_url": "https://github.com/dask/dask/issues/8355#issuecomment-1247157094",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8355",
        "id": 1247157094,
        "node_id": "IC_kwDOAbcwm85KVhtm",
        "user": {
            "login": "carlomarxdk",
            "id": 38817889,
            "node_id": "MDQ6VXNlcjM4ODE3ODg5",
            "avatar_url": "https://avatars.githubusercontent.com/u/38817889?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/carlomarxdk",
            "html_url": "https://github.com/carlomarxdk",
            "followers_url": "https://api.github.com/users/carlomarxdk/followers",
            "following_url": "https://api.github.com/users/carlomarxdk/following{/other_user}",
            "gists_url": "https://api.github.com/users/carlomarxdk/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/carlomarxdk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/carlomarxdk/subscriptions",
            "organizations_url": "https://api.github.com/users/carlomarxdk/orgs",
            "repos_url": "https://api.github.com/users/carlomarxdk/repos",
            "events_url": "https://api.github.com/users/carlomarxdk/events{/privacy}",
            "received_events_url": "https://api.github.com/users/carlomarxdk/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-09-14T18:35:25Z",
        "updated_at": "2022-09-14T18:36:06Z",
        "author_association": "NONE",
        "body": "**The workaround:** \r\nIt seems that if your index is sorted (and hence you specify `sorted=True` in case of `df2`), it works without errors.\r\n```from dask.distributed import Client\r\nimport dask.dataframe as dd\r\nimport pandas as pd\r\n\r\nclient = Client()\r\n\r\ndf = pd.DataFrame({\r\n    \"id\": pd.Series(dtype=\"str\"),\r\n    \"data\": pd.Series(dtype=\"int\")\r\n})\r\n\r\ndf2 = pd.DataFrame({\r\n    \"id\": pd.Series(dtype=\"str\"),\r\n    \"data\": pd.Series(dtype=\"int\")\r\n})\r\n\r\n# No error\r\nddf = dd.from_pandas(df, npartitions=1)\r\nddf.set_index(\"id\", npartitions=\"auto\")\r\n\r\n# No error (if you specify sorted = True)\r\nddf2 = dd.from_pandas(df2, npartitions=1)\r\nddf2.set_index(\"id\", npartitions=\"auto\", sorted=True) ```",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1247157094/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]