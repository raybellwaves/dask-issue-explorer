{
    "url": "https://api.github.com/repos/dask/dask/issues/3422",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/3422/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/3422/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/3422/events",
    "html_url": "https://github.com/dask/dask/issues/3422",
    "id": 315902153,
    "node_id": "MDU6SXNzdWUzMTU5MDIxNTM=",
    "number": 3422,
    "title": "Slices not fused in some cases",
    "user": {
        "login": "mrocklin",
        "id": 306380,
        "node_id": "MDQ6VXNlcjMwNjM4MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/306380?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mrocklin",
        "html_url": "https://github.com/mrocklin",
        "followers_url": "https://api.github.com/users/mrocklin/followers",
        "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
        "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
        "organizations_url": "https://api.github.com/users/mrocklin/orgs",
        "repos_url": "https://api.github.com/users/mrocklin/repos",
        "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mrocklin/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2018-04-19T14:26:35Z",
    "updated_at": "2021-10-12T05:42:21Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "Someone reported this to me in a side-channel.  Reproducing here.\r\n\r\nReproducer:\r\n\r\n```python\r\nclass A(object):\r\n    dtype = np.dtype('float64')\r\n    shape = (10,)\r\n\r\na = da.asarray(A())\r\n\r\nprint 'RECHUNK'\r\nprint '======='\r\npprint.pprint(dask.base.collections_to_dsk([a.rechunk(7)]),width=200)\r\n\r\nprint\r\nprint 'RECHUNK + ASTYPE'\r\nprint '================'\r\npprint.pprint(dask.base.collections_to_dsk([a.rechunk(7).astype('float32')]),width=200)\r\n```\r\n\r\nLeads to nice slice fusion here:\r\n\r\n```\r\nRECHUNK\r\n=======\r\n{'array-original-55fab0853cc9e527a51bf1324d69e099': <__main__.A object at 0x7fcca4f07690>,\r\n ('rechunk-merge-0e470de06bd3289659423047c743cc68', 0): ('rechunk-split-rechunk-merge-0e470de06bd3289659423047c743cc68', 0),\r\n ('rechunk-merge-0e470de06bd3289659423047c743cc68', 1): ('rechunk-split-rechunk-merge-0e470de06bd3289659423047c743cc68', 1),\r\n ('rechunk-split-rechunk-merge-0e470de06bd3289659423047c743cc68', 0): (<function getter at 0x7fcca5783cf8>, 'array-original-55fab0853cc9e527a51bf1324d69e099', (slice(0, 7, None),)),\r\n ('rechunk-split-rechunk-merge-0e470de06bd3289659423047c743cc68', 1): (<function getter at 0x7fcca5783cf8>, 'array-original-55fab0853cc9e527a51bf1324d69e099', (slice(7, 10, None),))}\r\n```\r\n\r\nbut no fusing here -- note the continued existence of `slice(0, 10, None)`:\r\n\r\n```\r\nRECHUNK + ASTYPE\r\n================\r\n{'array-original-55fab0853cc9e527a51bf1324d69e099': <__main__.A object at 0x7fcca4f07690>,\r\n ('astype-f6cb2b1e26daa58e45573bd2b2c9885e', 0): ('rechunk-merge-rechunk-split-astype-f6cb2b1e26daa58e45573bd2b2c9885e', 0),\r\n ('astype-f6cb2b1e26daa58e45573bd2b2c9885e', 1): ('rechunk-merge-rechunk-split-astype-f6cb2b1e26daa58e45573bd2b2c9885e', 1),\r\n ('rechunk-merge-rechunk-split-astype-f6cb2b1e26daa58e45573bd2b2c9885e', 0): (<built-in function apply>,\r\n                                                                              <function astype at 0x7fcca6ac0f50>,\r\n                                                                              [(<built-in function getitem>,\r\n                                                                                (<function getter_inline at 0x7fcca5783e60>,\r\n                                                                                 'array-original-55fab0853cc9e527a51bf1324d69e099',\r\n                                                                                 (slice(0, 10, None),)),\r\n                                                                                (slice(0, 7, None),))],\r\n                                                                              {'astype_dtype': dtype('float32')}),\r\n ('rechunk-merge-rechunk-split-astype-f6cb2b1e26daa58e45573bd2b2c9885e', 1): (<built-in function apply>,\r\n                                                                              <function astype at 0x7fcca6ac0f50>,\r\n                                                                              [(<built-in function getitem>,\r\n                                                                                (<function getter_inline at 0x7fcca5783e60>,\r\n                                                                                 'array-original-55fab0853cc9e527a51bf1324d69e099',\r\n                                                                                 (slice(0, 10, None),)),\r\n                                                                                (slice(7, 10, None),))],\r\n                                                                              {'astype_dtype': dtype('float32')})}\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/3422/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/3422/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}