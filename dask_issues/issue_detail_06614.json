{
    "url": "https://api.github.com/repos/dask/dask/issues/6614",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/6614/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/6614/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/6614/events",
    "html_url": "https://github.com/dask/dask/issues/6614",
    "id": 697153552,
    "node_id": "MDU6SXNzdWU2OTcxNTM1NTI=",
    "number": 6614,
    "title": "to_parquet fails when writing with index and append=True",
    "user": {
        "login": "mwiebusch78",
        "id": 4977570,
        "node_id": "MDQ6VXNlcjQ5Nzc1NzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4977570?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mwiebusch78",
        "html_url": "https://github.com/mwiebusch78",
        "followers_url": "https://api.github.com/users/mwiebusch78/followers",
        "following_url": "https://api.github.com/users/mwiebusch78/following{/other_user}",
        "gists_url": "https://api.github.com/users/mwiebusch78/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mwiebusch78/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mwiebusch78/subscriptions",
        "organizations_url": "https://api.github.com/users/mwiebusch78/orgs",
        "repos_url": "https://api.github.com/users/mwiebusch78/repos",
        "events_url": "https://api.github.com/users/mwiebusch78/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mwiebusch78/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 7,
    "created_at": "2020-09-09T20:58:27Z",
    "updated_at": "2020-11-11T21:46:06Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "I am trying to incrementally write a parquet file (or, more acurately, a parquet directory) with multiple calls to `to_parquet` with `append=True`. This fails when the data frame has an index.\r\n\r\nTo reproduce run the following code:\r\n\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\nfrom dask import dataframe as dd\r\n\r\nn = 2000\r\ndf = pd.DataFrame({'value': np.random.normal(size=n)}, index=pd.Index(np.arange(n), name='id'))\r\n\r\nappend = False\r\nfor i in range(0, n, 10):\r\n    part = dd.from_pandas(df.loc[i:i+10], npartitions=1)\r\n    part.to_parquet('test.parquet', append=append, engine='fastparquet', compression='gzip')\r\n    append = True\r\n\r\n```\r\n\r\nI get the following error:\r\n\r\n```\r\n---------------------------------------------------------------------------\r\nKeyError                                  Traceback (most recent call last)\r\n<ipython-input-1-5ca192e15a75> in <module>\r\n      9 for i in range(0, n, 10):\r\n     10     part = dd.from_pandas(df.loc[i:i+10], npartitions=1)\r\n---> 11     part.to_parquet('test.parquet', append=append, engine='fastparquet', compression='gzip')\r\n     12     append = True\r\n\r\n~/.pyenv/versions/3.8.5/lib/python3.8/site-packages/dask/dataframe/core.py in to_parquet(self, path, *args, **kwargs)\r\n   3945         from .io import to_parquet\r\n   3946 \r\n-> 3947         return to_parquet(self, path, *args, **kwargs)\r\n   3948 \r\n   3949     @derived_from(pd.DataFrame)\r\n\r\n~/.pyenv/versions/3.8.5/lib/python3.8/site-packages/dask/dataframe/io/parquet/core.py in to_parquet(df, path, engine, compression, write_index, append, ignore_divisions, partition_on, storage_options, write_metadata_file, compute, compute_kwargs, **kwargs)\r\n    440     # Engine-specific initialization steps to write the dataset.\r\n    441     # Possibly create parquet metadata, and load existing stuff if appending\r\n--> 442     meta, i_offset = engine.initialize_write(\r\n    443         df,\r\n    444         fs,\r\n\r\n~/.pyenv/versions/3.8.5/lib/python3.8/site-packages/dask/dataframe/io/parquet/fastparquet.py in initialize_write(cls, df, fs, path, append, partition_on, ignore_divisions, division_info, **kwargs)\r\n    562             if not ignore_divisions:\r\n    563                 minmax = fastparquet.api.sorted_partitioned_columns(pf)\r\n--> 564                 old_end = minmax[index_cols[0]][\"max\"][-1]\r\n    565                 divisions = division_info[\"divisions\"]\r\n    566                 if divisions[0] < old_end:\r\n\r\nKeyError: 'id'\r\n```\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2.23.0\r\n- Pandas version: 1.1.0\r\n- fastparquet version: 0.4.1\r\n- Python version: 3.8.5\r\n- Operating System: Mac OS X\r\n- Install method (conda, pip, source): pip\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/6614/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/6614/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}