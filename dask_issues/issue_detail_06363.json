{
    "url": "https://api.github.com/repos/dask/dask/issues/6363",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/6363/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/6363/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/6363/events",
    "html_url": "https://github.com/dask/dask/issues/6363",
    "id": 649492589,
    "node_id": "MDU6SXNzdWU2NDk0OTI1ODk=",
    "number": 6363,
    "title": "Loading metadata slow for zarr archives with many objects stored in GCS",
    "user": {
        "login": "rafa-guedes",
        "id": 7799184,
        "node_id": "MDQ6VXNlcjc3OTkxODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7799184?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rafa-guedes",
        "html_url": "https://github.com/rafa-guedes",
        "followers_url": "https://api.github.com/users/rafa-guedes/followers",
        "following_url": "https://api.github.com/users/rafa-guedes/following{/other_user}",
        "gists_url": "https://api.github.com/users/rafa-guedes/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/rafa-guedes/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rafa-guedes/subscriptions",
        "organizations_url": "https://api.github.com/users/rafa-guedes/orgs",
        "repos_url": "https://api.github.com/users/rafa-guedes/repos",
        "events_url": "https://api.github.com/users/rafa-guedes/events{/privacy}",
        "received_events_url": "https://api.github.com/users/rafa-guedes/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 365513534,
            "node_id": "MDU6TGFiZWwzNjU1MTM1MzQ=",
            "url": "https://api.github.com/repos/dask/dask/labels/io",
            "name": "io",
            "color": "6f871c",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2020-07-02T01:20:14Z",
    "updated_at": "2021-10-13T06:46:33Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "<!-- Please do a quick search of existing issues to make sure that this has not been asked before. -->\r\n\r\nI'm not sure if this topic would be more related to dask, zarr or xarray, apologies if this is not the correct place to post it.\r\n\r\nLoading metadata / coordinates from a zarr archive (stored on GCS) with xarray to build a dask array could take relatively long for archives with large number of objects. As an example, below is part of the profiling output from loading a dask array (from the same GCS region) from an archive with around 5e6 objects. The most costly calls are those 40 calls (1 per data variable in the dataset) to [dask.array.core.slices_from_chunks](https://github.com/dask/dask/blob/master/dask/array/core.py#L168) and [dask.array.core.getem](https://github.com/dask/dask/blob/master/dask/array/core.py#L187) functions.\r\n\r\nThe total time in these calls usually vary between 5 and 20 sec for this dataset. These times can be greatly reduced (to be sub-second) by decreasing the overall number of objects in the archive (by increasing the chunk sizes). My question is whether these loading times need to scale with the number of objects in the zarr store, considering the metadata are consolidated and the actual coordinate variables are stored in one single chunk.\r\n\r\nThanks\r\n\r\n```\r\n         545613 function calls (538362 primitive calls) in 10.786 seconds\r\n\r\n   Ordered by: internal time\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n       40    3.694    0.092    3.715    0.093 /usr/local/lib/python3.8/dist-packages/dask/array/core.py:168(slices_from_chunks)\r\n       40    3.163    0.079    3.163    0.079 /usr/local/lib/python3.8/dist-packages/dask/array/core.py:224(<listcomp>)\r\n       40    1.928    0.048    8.827    0.221 /usr/local/lib/python3.8/dist-packages/dask/array/core.py:187(getem)\r\n       93    1.408    0.015    1.408    0.015 {built-in method _openssl.SSL_read}\r\n       40    0.103    0.003    8.986    0.225 /usr/local/lib/python3.8/dist-packages/dask/array/core.py:2670(from_array)\r\n        3    0.064    0.021    0.065    0.022 /usr/local/lib/python3.8/dist-packages/zarr/core.py:1734(_decode_chunk)\r\n      275    0.025    0.000    0.025    0.000 {built-in method marshal.loads}\r\n       14    0.017    0.001    0.017    0.001 {method 'reduce' of 'numpy.ufunc' objects}\r\n    86463    0.015    0.000    0.021    0.000 /usr/local/lib/python3.8/dist-packages/toolz/itertoolz.py:31(accumulate)\r\n      669    0.010    0.000    0.023    0.000 {built-in method builtins.__build_class__}\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/6363/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/6363/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}