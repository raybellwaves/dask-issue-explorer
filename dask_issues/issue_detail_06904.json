{
    "url": "https://api.github.com/repos/dask/dask/issues/6904",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/6904/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/6904/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/6904/events",
    "html_url": "https://github.com/dask/dask/issues/6904",
    "id": 753080690,
    "node_id": "MDU6SXNzdWU3NTMwODA2OTA=",
    "number": 6904,
    "title": "Dask-ML: Error when fitting K-means model",
    "user": {
        "login": "rileyhun",
        "id": 20649466,
        "node_id": "MDQ6VXNlcjIwNjQ5NDY2",
        "avatar_url": "https://avatars.githubusercontent.com/u/20649466?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rileyhun",
        "html_url": "https://github.com/rileyhun",
        "followers_url": "https://api.github.com/users/rileyhun/followers",
        "following_url": "https://api.github.com/users/rileyhun/following{/other_user}",
        "gists_url": "https://api.github.com/users/rileyhun/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/rileyhun/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/rileyhun/subscriptions",
        "organizations_url": "https://api.github.com/users/rileyhun/orgs",
        "repos_url": "https://api.github.com/users/rileyhun/repos",
        "events_url": "https://api.github.com/users/rileyhun/events{/privacy}",
        "received_events_url": "https://api.github.com/users/rileyhun/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2020-11-30T01:56:35Z",
    "updated_at": "2020-12-01T15:59:16Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "**What happened**:\r\n\r\nI am following along to this example workbook [here\r\n](https://github.com/dask/dask-examples/blob/master/machine-learning/training-on-large-datasets.ipynb) The only difference is that I am using a remote Dask Cluster on Kubernetes. When I try to fit the model on the training data, my workers are killed.\r\n\r\n**What you expected to happen**:\r\n\r\nI expected the K-means model to be fitted on the training data and this outputted as the result:\r\n\r\n```\r\nKMeans(init_max_iter=2, n_clusters=3, oversampling_factor=10)\r\n```\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\n# connect to dask-gateway proxy\r\nauth = BasicAuth(password=secrets['dask_gateway_secret'])\r\ngateway = Gateway(\r\n    address=\"http://<PROXY_ADDRESS>:80\",\r\n    auth=auth\r\n)\r\n\r\noptions = gateway.cluster_options()\r\ncluster = gateway.new_cluster(options)\r\ncluster.scale(10)\r\nclient = cluster.get_client()\r\n\r\nX, y = dask_ml.datasets.make_blobs(n_samples=100000,\r\n                                   chunks=10000,\r\n                                   random_state=0,\r\n                                   centers=3\r\n                                  )\r\nX = X.persist()\r\nkm = dask_ml.cluster.KMeans(n_clusters=3, init_max_iter=2, oversampling_factor=10)\r\nkm.fit(X)\r\n```\r\n\r\nI get this error:\r\n\r\n```\r\nKilledWorker: (\"('from-value-getitem-concatenate-1a4b8dfc0f7e2576373f60d4ed2284da', 1, 0)\", <Worker 'tls://10.76.20.7:41413', name: dask-worker-9cdced85e7b94e3d8c8aec65c019ced0-qtp6v, memory: 0, processing: 11>)\r\n```\r\n\r\nFrom the Kubernetes logs of the dask workers, there seems to be some serialization problem with the pickle protocol \r\n\r\n```\r\ndistributed.protocol.pickle - INFO - Failed to deserialize b\"\\x80\\x04\\x95n\\x06\\x00\\x00\\x00\\x00\\x00\\x00(\\x8c\\x11dask.optimization\\x94\\x8c\\x10SubgraphCallable\\x94\\x93\\x94(}\\x94(\\x8c.centers_dense-8908a0302f0a8b5549b4350c5b4986cb\\x94\\x8c5astype-centers_dense-8908a0302f0a8b5549b4350c5b4986cb\\x94h\\x05(\\x8c\\x14numba.core.serialize\\x94\\x8c\\x12_rebuild_reduction\\x94\\x93\\x94(\\x8c\\x13numba.core.registry\\x94\\x8c\\rCPUDispatcher\\x94\\x93\\x94\\x8c$5890b4f0-32c0-11eb-820d-4201ac1e07dd\\x94(K\\x04C\\x04B\\r\\r\\n\\x94Bt\\x01\\x00\\x00\\xe3\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x08\\x00\\x00\\x00C\\x00\\x00\\x00sp\\x00\\x00\\x00|\\x00j\\x00d\\x01\\x19\\x00}\\x03|\\x00j\\x00d\\x02\\x19\\x00}\\x04t\\x01j\\x02|\\x02|\\x04f\\x02t\\x01j\\x03d\\x03\\x8d\\x02}\\x05xBt\\x04|\\x03\\x83\\x01D\\x00]6}\\x06x0t\\x04|\\x04\\x83\\x01D\\x00]$}\\x07|\\x05|\\x01|\\x06\\x19\\x00|\\x07f\\x02\\x05\\x00\\x19\\x00|\\x00|\\x06|\\x07f\\x02\\x19\\x007\\x00\\x03\\x00<\\x00q@W\\x00q2W\\x00|\\x05S\\x00)\\x04N\\xe9\\x00\\x00\\x00\\x00\\xe9\\x01\\x00\\x00\\x00)\\x01\\xda\\x05dtype)\\x05\\xda\\x05shape\\xda\\x02np\\xda\\x05zeros\\xda\\x07float64\\xda\\x05range)\\x08\\xda\\x01X\\xda\\x06labels\\xda\\nn_clusters\\xda\\tn_samples\\xda\\nn_features\\xda\\x07centers\\xda\\x01i\\xda\\x01j\\xa9\\x00r\\x11\\x00\\x00\\x00\\xfaA/opt/conda/lib/python3.7/site-packages/dask_ml/cluster/k_means.py\\xda\\x0e_centers_denseE\\x02\\x00\\x00s\\x0e\\x00\\x00\\x00\\x00\\x02\\n\\x01\\n\\x01\\x14\\x02\\x0e\\x01\\x0e\\x01(\\x02\\x94\\x87\\x94}\\x94(\\x8c\\x02np\\x94h\\x06\\x8c\\x0f_rebuild_module\\x94\\x93\\x94\\x8c\\x05numpy\\x94\\x85\\x94R\\x94\\x8c\\x05range\\x94\\x8c\\x08builtins\\x94\\x8c\\x05range\\x94\\x93\\x94\\x8c\\x08__name__\\x94\\x8c\\x17dask_ml.cluster.k_means\\x94u\\x8c\\x0e_centers_dense\\x94Nt\\x94}\\x94}\\x94(\\x8c\\x05nogil\\x94\\x88\\x8c\\x08fastmath\\x94\\x88\\x8c\\x08nopython\\x94\\x88\\x8c\\x0bboundscheck\\x94\\x89u\\x8c\\x06direct\\x94\\x88]\\x94t\\x94R\\x94\\x8c\\x02_0\\x94(\\x8c\\ndask.utils\\x94\\x8c\\x05apply\\x94\\x93\\x94\\x8c\\x10dask.array.chunk\\x94\\x8c\\x06astype\\x94\\x93\\x94]\\x94\\x8c\\x02_2\\x94ah\\x18\\x8c\\x04dict\\x94\\x93\\x94]\\x94]\\x94(\\x8c\\x0castype_dtype\\x94h\\x14\\x8c\\x05dtype\\x94\\x93\\x94\\x8c\\x02i4\\x94\\x89\\x88\\x87\\x94R\\x94(K\\x03\\x8c\\x01<\\x94NNNJ\\xff\\xff\\xff\\xffJ\\xff\\xff\\xff\\xffK\\x00t\\x94bea\\x86\\x94t\\x94\\x8c\\x02_1\\x94t\\x94uh\\x04(\\x8c\\x02_0\\x94\\x8c\\x02_1\\x94\\x8c\\x02_2\\x94\\x8c6('concatenate-6a3e052d16683f6d74278c3e2a96e5ce', 3, 0)\\x94t\\x94\\x8c\\x11subgraph_callable\\x94t\\x94R\\x94\\x8c6('concatenate-6a3e052d16683f6d74278c3e2a96e5ce', 3, 0)\\x94K\\x03\\x8c\\t_operator\\x94\\x8c\\x07getitem\\x94\\x93\\x94(h,\\x8c\\x18sklearn.metrics.pairwise\\x94\\x8c\\x1dpairwise_distances_argmin_min\\x94\\x93\\x94]\\x94(\\x8c6('concatenate-6a3e052d16683f6d74278c3e2a96e5ce', 3, 0)\\x94\\x8c\\x15numpy.core.multiarray\\x94\\x8c\\x0c_reconstruct\\x94\\x93\\x94h\\x14\\x8c\\x07ndarray\\x94\\x93\\x94K\\x00\\x85\\x94C\\x01b\\x94\\x87\\x94R\\x94(K\\x01K\\x03K\\x02\\x86\\x94h8\\x8c\\x02f8\\x94\\x89\\x88\\x87\\x94R\\x94(K\\x03h<NNNJ\\xff\\xff\\xff\\xffJ\\xff\\xff\\xff\\xffK\\x00t\\x94b\\x89C0:\\x12\\xe3hTB\\xfb\\xbf\\\\\\x8e\\xb8\\x0f5?\\x0b@\\x9d\\x1au\\xddIw\\x08@<H]rX\\xb8\\xea?\\xad(\\x9f\\x8a85\\xee?\\x10d\\xacW\\x87.\\x10@\\x94t\\x94beh3]\\x94(]\\x94(\\x8c\\x06metric\\x94\\x8c\\teuclidean\\x94e]\\x94(\\x8c\\rmetric_kwargs\\x94h3]\\x94]\\x94(\\x8c\\x07squared\\x94\\x88ea\\x86\\x94ee\\x86\\x94t\\x94K\\x00\\x87\\x94\\x8c6('concatenate-6a3e052d16683f6d74278c3e2a96e5ce', 3, 0)\\x94t\\x94.\"\r\nTraceback (most recent call last):\r\n  File \"/opt/conda/lib/python3.7/site-packages/distributed/protocol/pickle.py\", line 75, in loads\r\n    return pickle.loads(x)\r\n  File \"/opt/conda/lib/python3.7/site-packages/numba/core/serialize.py\", line 40, in _rebuild_reduction\r\n    return cls._rebuild(*args)\r\n  File \"/opt/conda/lib/python3.7/site-packages/numba/core/dispatcher.py\", line 787, in _rebuild\r\n    self = cls(py_func, locals, targetoptions, impl_kind)\r\n  File \"/opt/conda/lib/python3.7/site-packages/numba/core/dispatcher.py\", line 710, in __init__\r\n    pysig = utils.pysignature(py_func)\r\n  File \"/opt/conda/lib/python3.7/inspect.py\", line 3083, in signature\r\n    return Signature.from_callable(obj, follow_wrapped=follow_wrapped)\r\n  File \"/opt/conda/lib/python3.7/inspect.py\", line 2833, in from_callable\r\n    follow_wrapper_chains=follow_wrapped)\r\n  File \"/opt/conda/lib/python3.7/inspect.py\", line 2208, in _signature_from_callable\r\n    raise TypeError('{!r} is not a callable object'.format(obj))\r\nTypeError: ((4, b'B\\r\\r\\n', b'\\xe3\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x08\\x00\\x00\\x00\\x08\\x00\\x00\\x00C\\x00\\x00\\x00sp\\x00\\x00\\x00|\\x00j\\x00d\\x01\\x19\\x00}\\x03|\\x00j\\x00d\\x02\\x19\\x00}\\x04t\\x01j\\x02|\\x02|\\x04f\\x02t\\x01j\\x03d\\x03\\x8d\\x02}\\x05xBt\\x04|\\x03\\x83\\x01D\\x00]6}\\x06x0t\\x04|\\x04\\x83\\x01D\\x00]$}\\x07|\\x05|\\x01|\\x06\\x19\\x00|\\x07f\\x02\\x05\\x00\\x19\\x00|\\x00|\\x06|\\x07f\\x02\\x19\\x007\\x00\\x03\\x00<\\x00q@W\\x00q2W\\x00|\\x05S\\x00)\\x04N\\xe9\\x00\\x00\\x00\\x00\\xe9\\x01\\x00\\x00\\x00)\\x01\\xda\\x05dtype)\\x05\\xda\\x05shape\\xda\\x02np\\xda\\x05zeros\\xda\\x07float64\\xda\\x05range)\\x08\\xda\\x01X\\xda\\x06labels\\xda\\nn_clusters\\xda\\tn_samples\\xda\\nn_features\\xda\\x07centers\\xda\\x01i\\xda\\x01j\\xa9\\x00r\\x11\\x00\\x00\\x00\\xfaA/opt/conda/lib/python3.7/site-packages/dask_ml/cluster/k_means.py\\xda\\x0e_centers_denseE\\x02\\x00\\x00s\\x0e\\x00\\x00\\x00\\x00\\x02\\n\\x01\\n\\x01\\x14\\x02\\x0e\\x01\\x0e\\x01(\\x02'), {'np': <module 'numpy' from '/opt/conda/lib/python3.7/site-packages/numpy/__init__.py'>, 'range': <class 'range'>, '__name__': 'dask_ml.cluster.k_means'}, '_centers_dense', None) is not a callable object\r\n```\r\n\r\n**Anything else we need to know?**:\r\n\r\nNo version differences between the python packages on my client and that of my dask workers. \r\nWhen I created a dask cluster on my local machine, there are no issues. \r\n\r\n**Environment**:\r\n\r\n- Dask version: 2.30\r\n- Distributed version: 2.30.1\r\n- Python version: 3.7.8\r\n- Install method (conda, pip, source): conda\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/6904/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/6904/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}