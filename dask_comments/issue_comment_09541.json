[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1266243237",
        "html_url": "https://github.com/dask/dask/issues/9541#issuecomment-1266243237",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9541",
        "id": 1266243237,
        "node_id": "IC_kwDOAbcwm85LeVal",
        "user": {
            "login": "ian-r-rose",
            "id": 5728311,
            "node_id": "MDQ6VXNlcjU3MjgzMTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5728311?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ian-r-rose",
            "html_url": "https://github.com/ian-r-rose",
            "followers_url": "https://api.github.com/users/ian-r-rose/followers",
            "following_url": "https://api.github.com/users/ian-r-rose/following{/other_user}",
            "gists_url": "https://api.github.com/users/ian-r-rose/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/ian-r-rose/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/ian-r-rose/subscriptions",
            "organizations_url": "https://api.github.com/users/ian-r-rose/orgs",
            "repos_url": "https://api.github.com/users/ian-r-rose/repos",
            "events_url": "https://api.github.com/users/ian-r-rose/events{/privacy}",
            "received_events_url": "https://api.github.com/users/ian-r-rose/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-04T00:26:22Z",
        "updated_at": "2022-10-04T00:26:22Z",
        "author_association": "MEMBER",
        "body": "Thanks for the report and the nice example @mdrio (and sorry for the slow response). I see you're using `optimize_graph=False`, so it seems like you have likely already run into https://github.com/dask/dask/issues/7036 . \r\n\r\nUnfortunately, it looks to me like you've come across another place where we can inadvertently optimize out task annotations! In `dask.array.store` there is a manual optimization step which is not able to be turned off:\r\n\r\nhttps://github.com/dask/dask/blob/05e2db30395a812b3ab58a1a5a55099be10d772c/dask/array/core.py#L1168-L1172\r\n\r\nThe best fix for this (short of fixing #7036) is probably to complete https://github.com/dask/dask/issues/9381, which would allow blockwise annotations to be properly transmitted, and would generally use less custom logic in `store`.\r\n\r\nIn the meantime, you may be able to work around this behavior by deliberately introducing a `persist()` between `store` and your GPU operations:\r\n\r\n```python\r\nzeros = da.zeros(10)\r\nwith dask.annotate(resources={\"GPU\": 1}):\r\n    res = zeros.map_blocks(test_gpu, meta=np.array(()))\r\nres = res.persist(optimize_graph=False)\r\n\r\nwith dask.annotate(resources={\"CPU\": 1}):\r\n    zarr_array = da.to_zarr(\r\n        res,\r\n        \"/tmp/test.zarr\",\r\n        overwrite=True,\r\n        return_stored=True,\r\n    )\r\nzarr_array.compute(optimize_graph=False)\r\n```\r\n(though I should note that the above is pretty hacky)\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1266243237/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/1266905854",
        "html_url": "https://github.com/dask/dask/issues/9541#issuecomment-1266905854",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/9541",
        "id": 1266905854,
        "node_id": "IC_kwDOAbcwm85Lg3L-",
        "user": {
            "login": "mdrio",
            "id": 5130716,
            "node_id": "MDQ6VXNlcjUxMzA3MTY=",
            "avatar_url": "https://avatars.githubusercontent.com/u/5130716?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mdrio",
            "html_url": "https://github.com/mdrio",
            "followers_url": "https://api.github.com/users/mdrio/followers",
            "following_url": "https://api.github.com/users/mdrio/following{/other_user}",
            "gists_url": "https://api.github.com/users/mdrio/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mdrio/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mdrio/subscriptions",
            "organizations_url": "https://api.github.com/users/mdrio/orgs",
            "repos_url": "https://api.github.com/users/mdrio/repos",
            "events_url": "https://api.github.com/users/mdrio/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mdrio/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2022-10-04T12:20:48Z",
        "updated_at": "2022-10-04T12:20:48Z",
        "author_association": "NONE",
        "body": "Hi, I'll try the workaround ASAP, thanks!",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/1266905854/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]