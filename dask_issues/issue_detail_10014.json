{
    "url": "https://api.github.com/repos/dask/dask/issues/10014",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/10014/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/10014/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/10014/events",
    "html_url": "https://github.com/dask/dask/issues/10014",
    "id": 1607527567,
    "node_id": "I_kwDOAbcwm85f0OyP",
    "number": 10014,
    "title": "P2P shuffle fails on frames containing mixed dtype columns",
    "user": {
        "login": "charlesbluca",
        "id": 20627856,
        "node_id": "MDQ6VXNlcjIwNjI3ODU2",
        "avatar_url": "https://avatars.githubusercontent.com/u/20627856?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/charlesbluca",
        "html_url": "https://github.com/charlesbluca",
        "followers_url": "https://api.github.com/users/charlesbluca/followers",
        "following_url": "https://api.github.com/users/charlesbluca/following{/other_user}",
        "gists_url": "https://api.github.com/users/charlesbluca/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/charlesbluca/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/charlesbluca/subscriptions",
        "organizations_url": "https://api.github.com/users/charlesbluca/orgs",
        "repos_url": "https://api.github.com/users/charlesbluca/repos",
        "events_url": "https://api.github.com/users/charlesbluca/events{/privacy}",
        "received_events_url": "https://api.github.com/users/charlesbluca/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        },
        {
            "id": 3798450413,
            "node_id": "LA_kwDOAbcwm87iZ8Dt",
            "url": "https://api.github.com/repos/dask/dask/labels/bug",
            "name": "bug",
            "color": "faadaf",
            "default": true,
            "description": "Something is broken"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2023-03-02T21:27:05Z",
    "updated_at": "2023-04-03T01:50:45Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "<!-- Please include a self-contained copy-pastable example that generates the issue if possible.\r\n\r\nPlease be concise with code posted. See guidelines below on how to provide a good bug report:\r\n\r\n- Craft Minimal Bug Reports http://matthewrocklin.com/blog/work/2018/02/28/minimal-bug-reports\r\n- Minimal Complete Verifiable Examples https://stackoverflow.com/help/mcve\r\n\r\nBug reports that follow these guidelines are easier to diagnose, and so are often handled much more quickly.\r\n-->\r\n\r\n**Describe the issue**:\r\nThe `p2p` shuffle algorithm fails when working with frames that contain columns of mixed numeric/string dtypes; this error occurs during computation when Arrow attempts to cast the entire column to a numeric dtype:\r\n\r\n```\r\n2023-03-02 13:12:52,204 - distributed.shuffle - ERROR - shuffle_transfer failed during shuffle 4b4e0d18244b9cc2b7aadf328a683932\r\nTraceback (most recent call last):\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/shuffle/_shuffle.py\", line 58, in shuffle_transfer\r\n    return _get_worker_extension().add_partition(\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/shuffle/_worker_extension.py\", line 628, in add_partition\r\n    shuffle = self.get_or_create_shuffle(shuffle_id, type=type, **kwargs)\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/shuffle/_worker_extension.py\", line 879, in get_or_create_shuffle\r\n    return sync(\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/utils.py\", line 405, in sync\r\n    raise exc.with_traceback(tb)\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/utils.py\", line 378, in f\r\n    result = yield future\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/tornado/gen.py\", line 769, in run\r\n    value = future.result()\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/shuffle/_worker_extension.py\", line 709, in _get_or_create_shuffle\r\n    shuffle = await self._refresh_shuffle(\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/distributed/shuffle/_worker_extension.py\", line 758, in _refresh_shuffle\r\n    \"schema\": pa.Schema.from_pandas(kwargs[\"empty\"])\r\n  File \"pyarrow/types.pxi\", line 1739, in pyarrow.lib.Schema.from_pandas\r\n  File \"/raid/charlesb/mambaforge/envs/bug-ci-failures-p2p/lib/python3.9/site-packages/pyarrow/pandas_compat.py\", line 551, in dataframe_to_types\r\n    type_ = pa.array(c, from_pandas=True).type\r\n  File \"pyarrow/array.pxi\", line 316, in pyarrow.lib.array\r\n  File \"pyarrow/array.pxi\", line 83, in pyarrow.lib._ndarray_to_array\r\n  File \"pyarrow/error.pxi\", line 100, in pyarrow.lib.check_status\r\npyarrow.lib.ArrowInvalid: Could not convert 'a' with type str: tried to convert to double\r\n2023-03-02 13:12:52,278 - distributed.worker - WARNING - Compute Failed\r\nKey:       ('shuffle-transfer-4b4e0d18244b9cc2b7aadf328a683932', 0)\r\nFunction:  shuffle_transfer\r\nargs:      (     c  _partitions\r\n0  0.1            0\r\n1    a            0\r\n2    b            0\r\n3    c            0, '4b4e0d18244b9cc2b7aadf328a683932', 0, 1, '_partitions')\r\nkwargs:    {}\r\nException: \"RuntimeError('shuffle_transfer failed during shuffle 4b4e0d18244b9cc2b7aadf328a683932')\"\r\n```\r\n\r\n**Minimal Complete Verifiable Example**:\r\n\r\n```python\r\nimport dask\r\nimport dask.dataframe as dd\r\nfrom distributed import Client\r\n\r\nclient = Client()\r\n\r\nddf = dd.from_dict({\r\n    \"c\": [0.1, \"a\", \"b\", \"c\"]\r\n}, npartitions=1)\r\n\r\nwith dask.config.set({\"dataframe.shuffle.algorithm\" : \"p2p\"}):\r\n    res = ddf.groupby(\"c\").apply(lambda x: x).compute()\r\n```\r\n\r\n**Anything else we need to know?**:\r\nThis failure can be avoided by manually setting `dataframe.shuffle.algorithm` to disk or tasks, not sure if this could be handled more gracefully with either a warning or implicit fallback behavior; opening because this change in behavior caused some failures downstream in dask-sql (xref https://github.com/dask-contrib/dask-sql/pull/1067).\r\n\r\n**Environment**:\r\n\r\n- Dask version: `main`\r\n- Python version: 3.10\r\n- Operating System: ubuntu-20.04\r\n- Install method (conda, pip, source): source\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/10014/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/10014/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}