{
    "url": "https://api.github.com/repos/dask/dask/issues/8769",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/8769/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/8769/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/8769/events",
    "html_url": "https://github.com/dask/dask/issues/8769",
    "id": 1156185195,
    "node_id": "I_kwDOAbcwm85E6fxr",
    "number": 8769,
    "title": "DataFrame merge: clarify that merging on column puts all matching values into one partition",
    "user": {
        "login": "gjoseph92",
        "id": 3309802,
        "node_id": "MDQ6VXNlcjMzMDk4MDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3309802?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gjoseph92",
        "html_url": "https://github.com/gjoseph92",
        "followers_url": "https://api.github.com/users/gjoseph92/followers",
        "following_url": "https://api.github.com/users/gjoseph92/following{/other_user}",
        "gists_url": "https://api.github.com/users/gjoseph92/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/gjoseph92/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/gjoseph92/subscriptions",
        "organizations_url": "https://api.github.com/users/gjoseph92/orgs",
        "repos_url": "https://api.github.com/users/gjoseph92/repos",
        "events_url": "https://api.github.com/users/gjoseph92/events{/privacy}",
        "received_events_url": "https://api.github.com/users/gjoseph92/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2022-03-02T02:01:55Z",
    "updated_at": "2022-04-27T18:05:03Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "I naively tried to do `dd.merge(a, b, on=\"column_with_ten_values\")`, where `a` and `b` were both large DataFrames with thousands of partitions each.\r\n\r\nEventually the compute failed with:\r\n```python-traceback\r\n[File /opt/conda/envs/coiled/lib/python3.9/site-packages/dask/dataframe/multi.py:275, in merge_chunk()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/frame.py:9329, in merge()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/reshape/merge.py:122, in merge()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/reshape/merge.py:716, in get_result()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/reshape/merge.py:967, in _get_join_info()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/reshape/merge.py:941, in _get_join_indexers()\r\n\r\nFile /opt/conda/envs/coiled/lib/python3.9/site-packages/pandas/core/reshape/merge.py:1509, in get_join_indexers()\r\n\r\nFile ~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx:48, in pandas._libs.join.inner_join()\r\n     ]()[46](file:///~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx?line=45)[             count += lc * rc\r\n     ]()[47](file:///~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx?line=46)[ \r\n---> ]()[48](file:///~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx?line=47)[ left_indexer = np.empty(count, dtype=np.intp)\r\n     ]()[49](file:///~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx?line=48)[ right_indexer = np.empty(count, dtype=np.intp)\r\n     ]()[50](file:///~/Library/Caches/pypoetry/virtualenvs/workshop-one-3dbJnD_1-py3.9/lib/python3.9/site-packages/pandas/_libs/join.pyx?line=49)[ \r\n\r\nMemoryError: Unable to allocate 224. TiB for an array with shape (30824647463820,) and data type int64]()\r\n```\r\n\r\nI was confused why a 224 TiB array needed to be allocated. As a user, this was a strange and concerning error to see. Eventually I realized that my `on` column had only a few unique values, so (I think) it was trying to concatenate all those values across all partitions into one during the shuffle stage of the hash join. Because the shuffle ensures that:\r\n\r\n> After this operation all elements that have the same index will be in the same partition.\r\n\r\nIt would be good to:\r\n1. Document clearly that when merging on a column, every row with the same value needs to be able to fit into one partition. If there are only a few unique values for the column, but many rows, you'll likely encounter an error.\r\n2. Catch/preemptively check for this error at runtime, and reraise a more informative error to users. Not sure what alternative we'd suggest though. The fact that divisions, and by extension shuffling, can't handle repeated values (xref https://github.com/dask/dask/issues/8437) I think makes this fundamentally unsupported right now?\r\n\r\ncc @jsignell ",
    "closed_by": {
        "login": "jsignell",
        "id": 4806877,
        "node_id": "MDQ6VXNlcjQ4MDY4Nzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4806877?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jsignell",
        "html_url": "https://github.com/jsignell",
        "followers_url": "https://api.github.com/users/jsignell/followers",
        "following_url": "https://api.github.com/users/jsignell/following{/other_user}",
        "gists_url": "https://api.github.com/users/jsignell/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jsignell/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jsignell/subscriptions",
        "organizations_url": "https://api.github.com/users/jsignell/orgs",
        "repos_url": "https://api.github.com/users/jsignell/repos",
        "events_url": "https://api.github.com/users/jsignell/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jsignell/received_events",
        "type": "User",
        "site_admin": false
    },
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/8769/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/8769/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}