{
    "url": "https://api.github.com/repos/dask/dask/issues/5540",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/5540/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/5540/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/5540/events",
    "html_url": "https://github.com/dask/dask/issues/5540",
    "id": 513942430,
    "node_id": "MDU6SXNzdWU1MTM5NDI0MzA=",
    "number": 5540,
    "title": "Cross-Chunk Slicing Memory Error",
    "user": {
        "login": "trexfeathers",
        "id": 40734014,
        "node_id": "MDQ6VXNlcjQwNzM0MDE0",
        "avatar_url": "https://avatars.githubusercontent.com/u/40734014?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/trexfeathers",
        "html_url": "https://github.com/trexfeathers",
        "followers_url": "https://api.github.com/users/trexfeathers/followers",
        "following_url": "https://api.github.com/users/trexfeathers/following{/other_user}",
        "gists_url": "https://api.github.com/users/trexfeathers/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/trexfeathers/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/trexfeathers/subscriptions",
        "organizations_url": "https://api.github.com/users/trexfeathers/orgs",
        "repos_url": "https://api.github.com/users/trexfeathers/repos",
        "events_url": "https://api.github.com/users/trexfeathers/events{/privacy}",
        "received_events_url": "https://api.github.com/users/trexfeathers/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1372867996,
            "node_id": "MDU6TGFiZWwxMzcyODY3OTk2",
            "url": "https://api.github.com/repos/dask/dask/labels/discussion",
            "name": "discussion",
            "color": "bebaf4",
            "default": false,
            "description": "Discussing a topic with no specific actions yet"
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 8,
    "created_at": "2019-10-29T14:04:49Z",
    "updated_at": "2020-03-19T13:09:57Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "My team's userbase of scientists often need to slice data in shapes that result in each slice touching high numbers of the source data's chunks. This causes sub-optimal memory usage by Dask - see [Specifying Chunk shapes](https://docs.dask.org/en/latest/array-chunks.html#specifying-chunk-shapes) in the documentation. In some examples this is causing memory errors, and unfortunately the users have no control over the source data's chunking. The current difficulty with 'cross-chunk slicing' is therefore a blocker preventing this group of scientists from adopting Dask.\r\n\r\nCould changes be made to Dask that would remove this limitation, without negatively affecting performance in other scenarios? I see that this has been discussed in #3595, but that no conclusions have been reached since workarounds were possible. We are hoping a general solution may be reachable since developing case-by-case workarounds for each of our users is beyond the resource we have.\r\n\r\nI'd be happy to spend time upskilling enough to discuss / work on a solution myself, but first it would be very helpful to know whether this might be a dead-end or whether it is worth investing the time. Thanks!\r\n\r\n_The below two examples of \u2018cross-chunk slicing\u2019 cause memory errors with Dask 2.5.2, Numpy 1.17.2._\r\n\r\n<details>\r\n    <summary>System specs</summary>\r\n\r\n````\r\n$ lscpu\r\nArchitecture:          x86_64\r\nCPU op-mode(s):        32-bit, 64-bit\r\nByte Order:            Little Endian\r\nCPU(s):                4\r\nOn-line CPU(s) list:   0-3\r\nThread(s) per core:    1\r\nCore(s) per socket:    4\r\nSocket(s):             1\r\nNUMA node(s):          1\r\nVendor ID:             GenuineIntel\r\nCPU family:            6\r\nModel:                 79\r\nModel name:            Intel(R) Xeon(R) CPU E5-2690 v4 @ 2.60GHz\r\nStepping:              1\r\nCPU MHz:               2599.998\r\nBogoMIPS:              5199.99\r\nVirtualization:        VT-x\r\nHypervisor vendor:     VMware\r\nVirtualization type:   full\r\nL1d cache:             32K\r\nL1i cache:             32K\r\nL2 cache:              256K\r\nL3 cache:              35840K\r\nNUMA node0 CPU(s):     0-3\r\n````\r\n```\r\n$ lsmem\r\nRANGE                                 SIZE  STATE REMOVABLE BLOCK\r\n0x0000000000000000-0x00000000bfffffff   3G online        no  0-23\r\n0x0000000100000000-0x00000001bfffffff   3G online        no 32-55\r\n\r\nMemory block size:       128M\r\nTotal online memory:       6G\r\nTotal offline memory:      0B\r\n\r\n```\r\n\r\n</details>\r\n\r\n```python\r\n# Example using the shape of a real dataset that has this problem.\r\nshape_original = da.random.random(\r\n    size=[11280, 720, 1440],\r\n    chunks=[16, -1, -1])\r\nslice_original = shape_original[:, :71, :130]\r\nslice_original.compute()\r\n```\r\n```python\r\n# Simplified example demonstrating the same problem.\r\nshape_simplified = da.random.random(\r\n    size=[100000, 100000],\r\n    chunks=[1, -1])\r\nslice_simplified = shape_simplified[:, 1]\r\nslice_simplified.compute()\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/5540/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/5540/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}