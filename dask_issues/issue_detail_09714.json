{
    "url": "https://api.github.com/repos/dask/dask/issues/9714",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/9714/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/9714/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/9714/events",
    "html_url": "https://github.com/dask/dask/issues/9714",
    "id": 1475500051,
    "node_id": "I_kwDOAbcwm85X8lgT",
    "number": 9714,
    "title": "Generalized ufuncs don't always work for cupy chunked dask arrays",
    "user": {
        "login": "GenevieveBuckley",
        "id": 30920819,
        "node_id": "MDQ6VXNlcjMwOTIwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/30920819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GenevieveBuckley",
        "html_url": "https://github.com/GenevieveBuckley",
        "followers_url": "https://api.github.com/users/GenevieveBuckley/followers",
        "following_url": "https://api.github.com/users/GenevieveBuckley/following{/other_user}",
        "gists_url": "https://api.github.com/users/GenevieveBuckley/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/GenevieveBuckley/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/GenevieveBuckley/subscriptions",
        "organizations_url": "https://api.github.com/users/GenevieveBuckley/orgs",
        "repos_url": "https://api.github.com/users/GenevieveBuckley/repos",
        "events_url": "https://api.github.com/users/GenevieveBuckley/events{/privacy}",
        "received_events_url": "https://api.github.com/users/GenevieveBuckley/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        },
        {
            "id": 3798450413,
            "node_id": "LA_kwDOAbcwm87iZ8Dt",
            "url": "https://api.github.com/repos/dask/dask/labels/bug",
            "name": "bug",
            "color": "faadaf",
            "default": true,
            "description": "Something is broken"
        },
        {
            "id": 4410724893,
            "node_id": "LA_kwDOAbcwm88AAAABBuZSHQ",
            "url": "https://api.github.com/repos/dask/dask/labels/gpu",
            "name": "gpu",
            "color": "3D0CD2",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 9,
    "created_at": "2022-12-05T02:54:05Z",
    "updated_at": "2024-04-22T01:46:19Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "body": "# Issue summary\r\nDask generalized ufuncs do not work correctly when given Dask arrays containing cupy chunks.\r\n\r\nThis issue was first reported by @lrlunin in https://github.com/dask/dask-image/issues/275 (I'd prefer to transfer that issue here to avoid losing the discussion, but it appears that requires \"write\" instead of \"triage\" level access to both repos). I've copy-pasted the contents of [my comment](https://github.com/dask/dask-image/issues/275#issuecomment-1333148164) here.\r\n\r\n## Minimal reproducible example\r\nYou can run this quick test on [Google Colab](https://colab.research.google.com/), if you don't have a GPU on your local machine.\r\n1. From the Google Colab \"Runtime\" menu, click \"Change Runtime Type\" and check the runtime type is set to \"GPU\".\r\n2. Install cupy into the notebook environment. Copy-paste `!pip install cupy-cuda11x` into a notebook cell and execute it.\r\n\r\nI used [this docstring example](https://github.com/dask/dask/blob/main/dask/array/gufunc.py#L277-L283) to make a minimal, reproducible test.\r\n\r\nIt works as expected with a numpy backed dask array:\r\n```python\r\nimport dask.array as da\r\nimport numpy as np\r\n\r\ndef outer_product(x, y):\r\n    return np.einsum(\"i,j->ij\", x, y)\r\n\r\na = da.random.normal(size=(20,30), chunks=(10, 30))\r\nb = da.random.normal(size=(10, 1,40), chunks=(5, 1, 40))\r\nc = da.apply_gufunc(outer_product, \"(i),(j)->(i,j)\", a, b, vectorize=True)\r\nc.compute().shape\r\n# Expected output: (10, 20, 30, 40)\r\n# Works as expected\r\n```\r\n\r\nFails with a cupy backed dask array:\r\n```python\r\nimport dask.array as da\r\nimport cupy as cp\r\n\r\ndef outer_product(x, y):\r\n    return cp.einsum(\"i,j->ij\", x, y)\r\n\r\ndata_a = cp.random.normal(size=(20,30))\r\na = da.from_array(data_a, chunks=(10, 30))\r\ndata_b = cp.random.normal(size=(10, 1,40))\r\nb = da.from_array(data_b, chunks=(5, 1, 40))\r\nc = da.apply_gufunc(outer_product, \"(i),(j)->(i,j)\", a, b, vectorize=True)\r\nc.compute().shape\r\n# Expected output: (10, 20, 30, 40)\r\n# TypeError: Implicit conversion to a NumPy array is not allowed. Please use `.get()` to construct a NumPy array explicitly.\r\n```\r\n\r\nNotably, [this other docstring example](https://github.com/dask/dask/blob/main/dask/array/gufunc.py#L267-L274) *does* work with a dask array containing cupy chunks. This example does not use the `vectorize` keyword argument, which is probably why we don't see the problem here.\r\n\r\n## Hypothesis\r\nThere are several lines in [dask/array/gufunc.py](https://github.com/dask/dask/blob/main/dask/array/gufunc.py) that have numpy specific functions\r\n(`np.vectorize` and `np.newaxis`, see [here](https://github.com/dask/dask/blob/b1e468e8645baee30992fbfa84250d816ac1098a/dask/array/gufunc.py#L312), [here](https://github.com/dask/dask/blob/b1e468e8645baee30992fbfa84250d816ac1098a/dask/array/gufunc.py#L362), and [here](https://github.com/dask/dask/blob/b1e468e8645baee30992fbfa84250d816ac1098a/dask/array/gufunc.py#L508)). These lines might be causing this problem for dask arrays containing cupy chunks.\r\n\r\n## What we've tried so far\r\nTo test this idea, I tried switching out the `np.vectorize` functions for the [`cupy.vectorize` function](https://docs.cupy.dev/en/stable/reference/generated/cupy.vectorize.html). \r\n\r\nUnfortunately, cupy gives me this error: \r\n```\r\nNotImplementedError: cupy.vectorize does not support `signature` option currently.\r\n```\r\nSee [here](https://github.com/cupy/cupy/blob/v11.3.0/cupy/_functional/vectorize.py#L52-L55) in the cupy source code.\r\n\r\n## What to do next?\r\nWe could make a feature request issue in the [cupy repository](https://github.com/cupy/cupy/issues), for supporting the `signature` keyword argument in `cupy.vectorize`. I don't know where that request would fit in to their other priorities.\r\n\r\nIf that was implemented, Dask could then consider replacing the three numpy-specific lines in [dask/array/gufunc.py](https://github.com/dask/dask/blob/main/dask/array/gufunc.py) with some sort of dispatching solution, so that `np.vectorize` is used by numpy backed dask arrays, and `cupy.vectorize` is used by cupy backed dask arrays.\r\n\r\n**Environment**:\r\n\r\n- Dask version: 2022.2.0\r\n- Python version: 3.8.15\r\n- Operating System: [Google Colab](https://colab.research.google.com/) is running Linux version #1 SMP Fri Aug 26 08:44:51 UTC 2022\r\n- Install method (conda, pip, source):\r\n  - dask 2022.2.0 came pre-installed on Google Colab (presumably installed with pip)\r\n  - `pip install cupy-cuda11x` (installs version cupy-cuda11x-11.3.0)\r\n- CUDA information: `nvcc --version`\r\n```\r\nnvcc: NVIDIA (R) Cuda compiler driver\r\nCopyright (c) 2005-2021 NVIDIA Corporation\r\nBuilt on Sun_Feb_14_21:12:58_PST_2021\r\nCuda compilation tools, release 11.2, V11.2.152\r\nBuild cuda_11.2.r11.2/compiler.29618528_0\r\n```",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/9714/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/9714/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}