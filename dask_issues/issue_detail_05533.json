{
    "url": "https://api.github.com/repos/dask/dask/issues/5533",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/5533/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/5533/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/5533/events",
    "html_url": "https://github.com/dask/dask/issues/5533",
    "id": 512643045,
    "node_id": "MDU6SXNzdWU1MTI2NDMwNDU=",
    "number": 5533,
    "title": "Dataclass traversal breaks delayed __init__ and __post_init__",
    "user": {
        "login": "ahirner",
        "id": 6055037,
        "node_id": "MDQ6VXNlcjYwNTUwMzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6055037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ahirner",
        "html_url": "https://github.com/ahirner",
        "followers_url": "https://api.github.com/users/ahirner/followers",
        "following_url": "https://api.github.com/users/ahirner/following{/other_user}",
        "gists_url": "https://api.github.com/users/ahirner/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ahirner/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ahirner/subscriptions",
        "organizations_url": "https://api.github.com/users/ahirner/orgs",
        "repos_url": "https://api.github.com/users/ahirner/repos",
        "events_url": "https://api.github.com/users/ahirner/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ahirner/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 1968982461,
            "node_id": "MDU6TGFiZWwxOTY4OTgyNDYx",
            "url": "https://api.github.com/repos/dask/dask/labels/delayed",
            "name": "delayed",
            "color": "4f6edd",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-10-25T17:56:01Z",
    "updated_at": "2021-10-13T02:50:39Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "We use `dataclasses.dataclass` to instantiate resources. Since PR 4165, they are traversed and rebuilt on `delayed`. This causes:\r\n1) not being able to delay `__init__` and \r\n2) re-invokation of `__post_init__` .\r\n\r\n```python\r\nfrom dataclasses import dataclass\r\nfrom dask import delayed\r\n\r\n@dataclass\r\nclass D:\r\n    x: int\r\n    y: float\r\n    def __post_init__(self):\r\n        print(\"getting expensive resource\")\r\n        self.z = self.x + self.y\r\n    def __call__(self):\r\n        print(self.z, \"is ready\")\r\n        \r\nd = D(1,1.0)\r\n## getting expensive resource\r\nd()\r\n## 2.0 is ready\r\n\r\n# Problem 1)\r\n\r\n# Trying to instantiate a dataclass:\r\n# AttributeError: type object 'D' has no attribute 'x' in delayed::unpack_collections\r\n# because `is_dataclass` is True for D and instances of D\r\ndelayed(D)(1, 1.0).compute().z\r\n\r\n# Problem 2)\r\n\r\n# z is created twice\r\ndelayed(D(1, 1.0))().compute()\r\n## getting expensive resource\r\n## getting expensive resource\r\n## 2.0 is ready\r\n\r\n# z is created again\r\ndef operate_on(d: D):\r\n    d()\r\n    print(\"Thanks for\", d.z)\r\n\r\ndelayed(operate_on, traverse=False)(d).compute()\r\n## getting expensive resource\r\n## 2.0 is ready\r\n## Thanks for 2.0\r\n```\r\n_dask 2.6 (and also on 2.2)\r\npython 3.6.7 with dataclass backport_\r\n\r\n\r\nI think we can work around by delaying collections with dataclasses separately. However, I'm not sure if there are more elegant ways. \r\n\r\nPassing traverse=False down to `Delayed.__call__`  is maybe one way, or discriminating between dataclasses with and without `__post_init__` at some point.\r\n\r\n(edits: wording and traverse=False for last example)",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/5533/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/5533/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}