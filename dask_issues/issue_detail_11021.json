{
    "url": "https://api.github.com/repos/dask/dask/issues/11021",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/11021/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/11021/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/11021/events",
    "html_url": "https://github.com/dask/dask/issues/11021",
    "id": 2205755857,
    "node_id": "I_kwDOAbcwm86DeSnR",
    "number": 11021,
    "title": "Preserving divisions when reading/loading dataframes with structs containing multiple fields",
    "user": {
        "login": "PhilippeMoussalli",
        "id": 47530815,
        "node_id": "MDQ6VXNlcjQ3NTMwODE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/47530815?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PhilippeMoussalli",
        "html_url": "https://github.com/PhilippeMoussalli",
        "followers_url": "https://api.github.com/users/PhilippeMoussalli/followers",
        "following_url": "https://api.github.com/users/PhilippeMoussalli/following{/other_user}",
        "gists_url": "https://api.github.com/users/PhilippeMoussalli/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/PhilippeMoussalli/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/PhilippeMoussalli/subscriptions",
        "organizations_url": "https://api.github.com/users/PhilippeMoussalli/orgs",
        "repos_url": "https://api.github.com/users/PhilippeMoussalli/repos",
        "events_url": "https://api.github.com/users/PhilippeMoussalli/events{/privacy}",
        "received_events_url": "https://api.github.com/users/PhilippeMoussalli/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        },
        {
            "id": 365513534,
            "node_id": "MDU6TGFiZWwzNjU1MTM1MzQ=",
            "url": "https://api.github.com/repos/dask/dask/labels/io",
            "name": "io",
            "color": "6f871c",
            "default": false,
            "description": ""
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2024-03-25T13:21:46Z",
    "updated_at": "2024-04-04T12:51:48Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "Hi, \r\n\r\nWe're facing issue preserving divisions when writing pyarrow structs containing multiple fields, this is better illustrated in the following example: \r\n\r\n```python\r\ndata = {\r\n    'id': [\"01\", \"02\", \"03\", \"04\", \"05\", \"06\", \"07\", \"08\", \"09\", \"10\"],\r\n    'A': [11, 12, 13, 14, 15, 16, 17, 18, 19, 20],\r\n\r\n}\r\ndf = pd.DataFrame(data)\r\n\r\n# Create a Dask DataFrame\r\nddf = dd.from_pandas(df, npartitions=3)  # Set the number of partitions\r\n\r\n# Sort the index\r\nddf = ddf.set_index('id', drop=True, sorted=True)\r\n\r\n\r\ndef add_nested_struct_multiple_fields(rows):\r\n\r\n    example_dict = {\r\n        \"foo\": \"foo\",\r\n        \"bar\": \"bar\",\r\n    }\r\n\r\n    return [example_dict, example_dict]\r\n\r\ndef transform_multiple_fields(dataframe):\r\n\r\n    dataframe[\"nested_struct\"] = dataframe.apply(add_nested_struct_multiple_fields, axis=1)\r\n    \r\n    return dataframe\r\n\r\nnested_struct_multiple_fields_schema = pa.list_(\r\n            pa.struct(\r\n                [\r\n                    pa.field(\"foo\", pa.string()),\r\n                    pa.field(\"bar\", pa.string()),\r\n                ],\r\n        )\r\n)\r\n\r\ndef create_meta_dict(nested_struct_schema):\r\n    meta_dict = {\"id\": pd.Series(dtype=\"object\")}\r\n    meta_dict[\"A\"] = pd.Series(dtype=pd.ArrowDtype(pa.int32()))\r\n    meta_dict[\"nested_struct\"] = pd.Series(dtype=pd.ArrowDtype(nested_struct_schema))\r\n    meta_df = pd.DataFrame(meta_dict).set_index(\"id\")\r\n\r\n    return meta_df\r\n\r\n\r\nschema_nested_struct_multiple_fields = {\r\n    \"A\":pa.int32(),\r\n    \"nested_struct\":nested_struct_multiple_fields_schema\r\n}\r\n\r\nddf_multiple_fields = ddf.map_partitions(\r\n    transform_multiple_fields,\r\n    meta=nested_struct_multiple_fields_meta,\r\n)\r\n\r\nddf_multiple_fields.known_divisions\r\n-> True # Divisions are still preserved before writing \r\n\r\ndd.to_parquet(ddf_multiple_fields, \"multiple_fields\", schema=schema_nested_struct_multiple_fields)\r\n\r\ndd.read_parquet(path=\"multiple_fields\", index=\"id\", calculate_divisions=True).known_divisions\r\n-> False # Division are not known after reading the saved dataframe again \r\n```\r\n\r\nHere, we are writing two new fields (\"foo\", \"bar\"), when reading the parquet file again, the divisions are not preserved. Oddly enough this does not seem to occur when only one field is added to the struct. See [this notebook](https://colab.research.google.com/drive/1-aAeaU9yZYT7Qguh9EeNO5Gg8Y7A4nHn?usp=sharing) for more clarity on the issue where we compare both scenarios. \r\n\r\nCould you please provide clarity on the issue? Thanks in advance! \r\n\r\n**Environment**:\r\n\r\n- Dask version: 2024.2.1\r\n- Python version: 3.11\r\n- Operating System: Linux\r\n- Install method (conda, pip, source): pip\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/11021/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/11021/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}