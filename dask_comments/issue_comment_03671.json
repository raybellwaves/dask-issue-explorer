[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/400451888",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-400451888",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 400451888,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDQ1MTg4OA==",
        "user": {
            "login": "jakirkham",
            "id": 3019665,
            "node_id": "MDQ6VXNlcjMwMTk2NjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jakirkham",
            "html_url": "https://github.com/jakirkham",
            "followers_url": "https://api.github.com/users/jakirkham/followers",
            "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
            "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
            "organizations_url": "https://api.github.com/users/jakirkham/orgs",
            "repos_url": "https://api.github.com/users/jakirkham/repos",
            "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jakirkham/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-06-26T20:31:48Z",
        "updated_at": "2018-06-26T20:31:48Z",
        "author_association": "MEMBER",
        "body": "Could you please clarify what commit of Dask you are using?",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/400451888/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/400452339",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-400452339",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 400452339,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDQ1MjMzOQ==",
        "user": {
            "login": "jakirkham",
            "id": 3019665,
            "node_id": "MDQ6VXNlcjMwMTk2NjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jakirkham",
            "html_url": "https://github.com/jakirkham",
            "followers_url": "https://api.github.com/users/jakirkham/followers",
            "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
            "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
            "organizations_url": "https://api.github.com/users/jakirkham/orgs",
            "repos_url": "https://api.github.com/users/jakirkham/repos",
            "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jakirkham/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-06-26T20:33:13Z",
        "updated_at": "2018-06-26T20:33:13Z",
        "author_association": "MEMBER",
        "body": "Also does this issue show up in 0.18.0 or 0.18.1?",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/400452339/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/400568788",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-400568788",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 400568788,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDU2ODc4OA==",
        "user": {
            "login": "magnunor",
            "id": 1690979,
            "node_id": "MDQ6VXNlcjE2OTA5Nzk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1690979?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/magnunor",
            "html_url": "https://github.com/magnunor",
            "followers_url": "https://api.github.com/users/magnunor/followers",
            "following_url": "https://api.github.com/users/magnunor/following{/other_user}",
            "gists_url": "https://api.github.com/users/magnunor/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/magnunor/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/magnunor/subscriptions",
            "organizations_url": "https://api.github.com/users/magnunor/orgs",
            "repos_url": "https://api.github.com/users/magnunor/repos",
            "events_url": "https://api.github.com/users/magnunor/events{/privacy}",
            "received_events_url": "https://api.github.com/users/magnunor/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-06-27T07:19:32Z",
        "updated_at": "2018-06-27T07:19:32Z",
        "author_association": "CONTRIBUTOR",
        "body": "Commit: 59d8c9c09199afefd16de8503de1fa7323cd2eba\r\n\r\nI tested different versions of Dask and NumPy, and they all had the large memory use:\r\n\r\nNumPy: 1.14.5. Dask: 0.17.5\r\nNumPy: 1.14.5. Dask: 0.18.1\r\nNumPy: 1.14.5. Dask: 59d8c9c09199afefd16de8503de1fa7323cd2eba\r\n\r\nNumPy: 1.16.0.dev0+7dace1d (current master branch). Dask: 59d8c9c09199afefd16de8503de1fa7323cd2eba",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/400568788/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/439392440",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-439392440",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 439392440,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTM5MjQ0MA==",
        "user": {
            "login": "mrocklin",
            "id": 306380,
            "node_id": "MDQ6VXNlcjMwNjM4MA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/306380?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrocklin",
            "html_url": "https://github.com/mrocklin",
            "followers_url": "https://api.github.com/users/mrocklin/followers",
            "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
            "organizations_url": "https://api.github.com/users/mrocklin/orgs",
            "repos_url": "https://api.github.com/users/mrocklin/repos",
            "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrocklin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-11-16T13:27:20Z",
        "updated_at": "2018-11-16T13:27:20Z",
        "author_association": "MEMBER",
        "body": "Sorry for the long delay in response.  Your array has very very small chunks.  This results in the task graph of the array being 250k tasks *before* calling map overlap, which will probabl increase this by an order of magnitude.  I suspect that you're running into memory issues not with the computation, but with the task graph that describes the computation.",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/439392440/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/439467774",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-439467774",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 439467774,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTQ2Nzc3NA==",
        "user": {
            "login": "magnunor",
            "id": 1690979,
            "node_id": "MDQ6VXNlcjE2OTA5Nzk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1690979?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/magnunor",
            "html_url": "https://github.com/magnunor",
            "followers_url": "https://api.github.com/users/magnunor/followers",
            "following_url": "https://api.github.com/users/magnunor/following{/other_user}",
            "gists_url": "https://api.github.com/users/magnunor/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/magnunor/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/magnunor/subscriptions",
            "organizations_url": "https://api.github.com/users/magnunor/orgs",
            "repos_url": "https://api.github.com/users/magnunor/repos",
            "events_url": "https://api.github.com/users/magnunor/events{/privacy}",
            "received_events_url": "https://api.github.com/users/magnunor/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-11-16T17:31:41Z",
        "updated_at": "2018-11-16T17:31:41Z",
        "author_association": "CONTRIBUTOR",
        "body": "I changed the scripts a little bit, to increase the chunk size. Using the most recent version from the master branch.\r\n\r\n#### Map blocks\r\n\r\n```python\r\nimport numpy as np\r\nimport dask.array as da\r\nfrom dask.diagnostics import ProgressBar\r\n\r\ndef remove_dead_pixels(data):\r\n    dead_pixels = data == 0\r\n    output_data = np.roll(data, shift=1, axis=-2) * dead_pixels\r\n    return output_data\r\n\r\ndata = da.random.randint(0, 100000, size=(500, 500, 300, 300), chunks=(50, 50, 60, 60))\r\ntemp_data = da.map_blocks(remove_dead_pixels, data, dtype=data.dtype, chunks=data.chunks)\r\ntemp_data_mean = temp_data.mean(axis=(0, 1))\r\nwith ProgressBar():\r\n    temp_data_mean_computed = temp_data_mean.compute()\r\n\r\n# Uses about 5.5 GB\r\n```\r\n\r\n#### Map overlap\r\n```python\r\nimport numpy as np\r\nimport dask.array as da\r\nfrom dask.diagnostics import ProgressBar\r\n\r\ndef remove_dead_pixels(data):\r\n    dead_pixels = data == 0\r\n    output_data = np.roll(data, shift=1, axis=-2) * dead_pixels\r\n    return output_data\r\n\r\ndata = da.random.randint(0, 100000, size=(500, 500, 300, 300), chunks=(50, 50, 60, 60))\r\ntemp_data = da.map_overlap(\r\n        func=remove_dead_pixels, x=data, depth=(0, 0, 1, 1),\r\n        dtype=data.dtype, chunks=data.chunks)\r\ntemp_data_mean = temp_data.mean(axis=(0, 1))\r\nwith ProgressBar():\r\n    temp_data_mean_computed = temp_data_mean.compute()\r\n\r\n# Uses about 43 GB\r\n```\r\n\r\nTesting a bit further in the `map_overlap` script:\r\n\r\n- `depth=(0, 0, 0, 0)`. memory use: 4 GB\r\n- `depth=(0, 0, 0, 1)`. memory use: 6.3 GB\r\n- `depth=(0, 0, 1, 0)`. memory use: 6.2 GB\r\n- Using `temp_data_mean.compute(num_workers=1)`: memory use 40 GB\r\n\r\nSo I got a feeling the extra `overlap` chunks are somehow not cleared from memory?",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/439467774/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/439472890",
        "html_url": "https://github.com/dask/dask/issues/3671#issuecomment-439472890",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/3671",
        "id": 439472890,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQzOTQ3Mjg5MA==",
        "user": {
            "login": "mrocklin",
            "id": 306380,
            "node_id": "MDQ6VXNlcjMwNjM4MA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/306380?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mrocklin",
            "html_url": "https://github.com/mrocklin",
            "followers_url": "https://api.github.com/users/mrocklin/followers",
            "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
            "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
            "organizations_url": "https://api.github.com/users/mrocklin/orgs",
            "repos_url": "https://api.github.com/users/mrocklin/repos",
            "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mrocklin/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2018-11-16T17:49:58Z",
        "updated_at": "2018-11-16T17:49:58Z",
        "author_association": "MEMBER",
        "body": "My guess is that it's more a coordination thing, for dask to compute any particular chunk it needs all of the other chunks around it to also be in memory.  If you have a bunch of cores doing that all at once then maybe there are a large number of chunks in ram at once.  \r\n\r\nI would probably diagnose this by looking at `result.visualize(color='order', filename='dask.pdf')` or something similar, and look for a smooth color gradient (hopefully this makes sense once you see the image).  The visualize mechanism uses graphviz for layout, so this only works up to a few hundred tasks in the task graph, so typically one needs to construct a much smaller version of whatever problem you're working on.",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/439472890/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]