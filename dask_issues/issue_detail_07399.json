{
    "url": "https://api.github.com/repos/dask/dask/issues/7399",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/7399/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/7399/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/7399/events",
    "html_url": "https://github.com/dask/dask/pull/7399",
    "id": 832174320,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NTkzMzc3Njcx",
    "number": 7399,
    "title": "DataFrame: allow map_partitions to make Arrays with non-NumPy chunks",
    "user": {
        "login": "gjoseph92",
        "id": 3309802,
        "node_id": "MDQ6VXNlcjMzMDk4MDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3309802?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gjoseph92",
        "html_url": "https://github.com/gjoseph92",
        "followers_url": "https://api.github.com/users/gjoseph92/followers",
        "following_url": "https://api.github.com/users/gjoseph92/following{/other_user}",
        "gists_url": "https://api.github.com/users/gjoseph92/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/gjoseph92/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/gjoseph92/subscriptions",
        "organizations_url": "https://api.github.com/users/gjoseph92/orgs",
        "repos_url": "https://api.github.com/users/gjoseph92/repos",
        "events_url": "https://api.github.com/users/gjoseph92/events{/privacy}",
        "received_events_url": "https://api.github.com/users/gjoseph92/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 7,
    "created_at": "2021-03-15T20:39:18Z",
    "updated_at": "2021-06-18T16:54:02Z",
    "closed_at": null,
    "author_association": "MEMBER",
    "active_lock_reason": null,
    "draft": true,
    "pull_request": {
        "url": "https://api.github.com/repos/dask/dask/pulls/7399",
        "html_url": "https://github.com/dask/dask/pull/7399",
        "diff_url": "https://github.com/dask/dask/pull/7399.diff",
        "patch_url": "https://github.com/dask/dask/pull/7399.patch",
        "merged_at": null
    },
    "body": "Currently, if your `map_partitions` function returns an array-like object that's not a NumPy array (and has a dtype which isn't a NumPy dtype), `map_partitions` will fail when constructing `meta`. This PR allows whatever `meta` was produced to pass through directly to the Array. This _should_ make mapped functions that return pandas ExtensionArrays \"just work\" (can add some tests that that's so if we want to go ahead with this). And if the ExtensionArray type won't behave well as an Array chunk type for a particular operation, then hopefully doing that operation on the `meta` should fail as well.\r\n\r\nThis was a 1-line change, but it then breaks other tests:\r\n\r\n* `DataFrame.to_records` now produces an Array where the `meta` is an `np.recarray`, not an `np.ndarray`\r\n* But when you `compute` an Array of `recarray`s, the chunks get concatenated with `np.concatenate`, which doesn't preserve ndarray subclasses. This causes `assert_eq` to complain that the type changed when computed (meta type is `recarray`, computed type is `ndarray`).\r\n* When you make `concatenate` preserve ndarray subclasses, `test_to_npy_stack` fails, because the `meta` for the Array indicated `ndarray`, but the result was actually `memmap` (because the chunks are `memmap`s, which we now preserve).\r\n\r\nSo that's why I also added logic for concatenate to preserve ndarray subclasses. If we even are okay with that change, I'd be fine splitting it to a separate PR for clarity.\r\n\r\ncc @jrbourbeau: is this worth doing?\r\n\r\nRelated to https://github.com/dask/dask/issues/7377#issuecomment-799594266 and #7206.\r\n\r\n- [ ] Tests added / passed\r\n- [x] Passes `black dask` / `flake8 dask`\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/7399/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/7399/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}