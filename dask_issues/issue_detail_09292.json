{
    "url": "https://api.github.com/repos/dask/dask/issues/9292",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/9292/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/9292/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/9292/events",
    "html_url": "https://github.com/dask/dask/issues/9292",
    "id": 1309938141,
    "node_id": "I_kwDOAbcwm85OFBHd",
    "number": 9292,
    "title": "groupby performance degrades rapidly as column cardinality increases",
    "user": {
        "login": "MrPowers",
        "id": 2722395,
        "node_id": "MDQ6VXNlcjI3MjIzOTU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2722395?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MrPowers",
        "html_url": "https://github.com/MrPowers",
        "followers_url": "https://api.github.com/users/MrPowers/followers",
        "following_url": "https://api.github.com/users/MrPowers/following{/other_user}",
        "gists_url": "https://api.github.com/users/MrPowers/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/MrPowers/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MrPowers/subscriptions",
        "organizations_url": "https://api.github.com/users/MrPowers/orgs",
        "repos_url": "https://api.github.com/users/MrPowers/repos",
        "events_url": "https://api.github.com/users/MrPowers/events{/privacy}",
        "received_events_url": "https://api.github.com/users/MrPowers/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862289,
            "node_id": "MDU6TGFiZWwyNDI4NjIyODk=",
            "url": "https://api.github.com/repos/dask/dask/labels/dataframe",
            "name": "dataframe",
            "color": "fbca04",
            "default": false,
            "description": null
        },
        {
            "id": 1372867996,
            "node_id": "MDU6TGFiZWwxMzcyODY3OTk2",
            "url": "https://api.github.com/repos/dask/dask/labels/discussion",
            "name": "discussion",
            "color": "bebaf4",
            "default": false,
            "description": "Discussing a topic with no specific actions yet"
        },
        {
            "id": 2949099791,
            "node_id": "MDU6TGFiZWwyOTQ5MDk5Nzkx",
            "url": "https://api.github.com/repos/dask/dask/labels/parquet",
            "name": "parquet",
            "color": "77A66C",
            "default": false,
            "description": ""
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2022-07-19T19:13:09Z",
    "updated_at": "2022-09-07T16:00:42Z",
    "closed_at": null,
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "body": "Dask can perform groupby operations relatively well for columns with low cardinality, but performance seems to degrade significantly for columns with more distinct values.\r\n\r\nLet's look at the h2o groupby benchmarks for some examples on the 1e9 dataset (contains one billion rows and is 50 GB on disk when stored as an uncompressed CSV file).\r\n\r\nLet's query this dataset with a 16 node i3.large cluster (244 GB of cluster RAM total).  Here's a query that returns 10,000 distinct row groups (i.e. the result has 10,000 rows) and takes 37 seconds to execute.  Here's [the notebook](https://github.com/coiled/coiled-resources/blob/main/benchmarks/h2o-groupby-query2.ipynb) with complete details on how to build the software environment, the cluster info, all the code, etc.\r\n\r\n```python\r\nddf = dd.read_parquet(\r\n    \"s3://coiled-datasets/h2o-benchmark/N_1e9_K_1e2_parquet\",\r\n    storage_options={\"anon\": True, \"use_ssl\": True},\r\n    columns=[\"id1\", \"id2\", \"v1\"],\r\n    engine=\"pyarrow\",\r\n)\r\n\r\nddf.groupby([\"id1\", \"id2\"], dropna=False, observed=True).agg({\"v1\": \"sum\"}).compute()\r\n```\r\n\r\nHere's a different groupby query on the same dataset that returns a million row groups.  I ran this query for a half hour or so and then it errored out with a KilledWorker exception.  Here's [the notebook](https://github.com/coiled/coiled-resources/blob/main/benchmarks/h2o-groupby-query3.ipynb).\r\n\r\n```python\r\nddf = dd.read_parquet(\r\n    \"s3://coiled-datasets/h2o-benchmark/N_1e9_K_1e2_parquet\",\r\n    storage_options={\"anon\": True, \"use_ssl\": True},\r\n    columns=[\"id3\", \"v1\", \"v3\"],\r\n    engine=\"pyarrow\",\r\n)\r\n\r\nddf.groupby(\"id3\", dropna=False, observed=True).agg(\r\n    {\"v1\": \"sum\", \"v3\": \"mean\"}\r\n).compute()\r\n```\r\n\r\nLet's try to get this running by using the `pyarrow[string]` data type and by repartitioning first.  The `pyarrow[string]` dtype massively shrinks the memory footprint of the DataFrame from 224GB to 37GB.  This query still errors out with a KilledWorker exception.\r\n\r\n```python\r\nddf[\"id3\"] = ddf[\"id3\"].astype(\"string[pyarrow]\")\r\n\r\nddf.repartition(200).groupby(\"id3\", dropna=False, observed=True).agg(\r\n    {\"v1\": \"sum\", \"v3\": \"mean\"}\r\n).compute()\r\n```\r\n\r\nIt's the same dataset and the same cluster, so it seems like the issue is caused by the cardinality of the groupby column.  I'm interested in hearing what other folks think is the root cause.  Let me know if there is any additional info I can provide to give you with more context.  I'm happy to take pictures of dashboards, look at logs, etc.",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/9292/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/9292/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}