{
    "url": "https://api.github.com/repos/dask/dask/issues/10452",
    "repository_url": "https://api.github.com/repos/dask/dask",
    "labels_url": "https://api.github.com/repos/dask/dask/issues/10452/labels{/name}",
    "comments_url": "https://api.github.com/repos/dask/dask/issues/10452/comments",
    "events_url": "https://api.github.com/repos/dask/dask/issues/10452/events",
    "html_url": "https://github.com/dask/dask/issues/10452",
    "id": 1858663577,
    "node_id": "I_kwDOAbcwm85uyPSZ",
    "number": 10452,
    "title": "using dask.array.full_like can raise strange \"no Client active\" error",
    "user": {
        "login": "jerry-kobold",
        "id": 97456409,
        "node_id": "U_kgDOBc8RGQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/97456409?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jerry-kobold",
        "html_url": "https://github.com/jerry-kobold",
        "followers_url": "https://api.github.com/users/jerry-kobold/followers",
        "following_url": "https://api.github.com/users/jerry-kobold/following{/other_user}",
        "gists_url": "https://api.github.com/users/jerry-kobold/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jerry-kobold/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jerry-kobold/subscriptions",
        "organizations_url": "https://api.github.com/users/jerry-kobold/orgs",
        "repos_url": "https://api.github.com/users/jerry-kobold/repos",
        "events_url": "https://api.github.com/users/jerry-kobold/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jerry-kobold/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 242862305,
            "node_id": "MDU6TGFiZWwyNDI4NjIzMDU=",
            "url": "https://api.github.com/repos/dask/dask/labels/array",
            "name": "array",
            "color": "006b75",
            "default": false,
            "description": null
        },
        {
            "id": 1342320181,
            "node_id": "MDU6TGFiZWwxMzQyMzIwMTgx",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20info",
            "name": "needs info",
            "color": "d0cfcc",
            "default": false,
            "description": "Needs further information from the user"
        },
        {
            "id": 3468123446,
            "node_id": "LA_kwDOAbcwm87Ot102",
            "url": "https://api.github.com/repos/dask/dask/labels/needs%20attention",
            "name": "needs attention",
            "color": "6d626c",
            "default": false,
            "description": "It's been a while since this was pushed on. Needs attention from the owner or a maintainer."
        }
    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2023-08-21T06:07:21Z",
    "updated_at": "2023-09-25T01:45:33Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "Under dask and distributed 2023.6.0, using the `dask.array.full_like` function can lead to a strange error claiming that there is \"no Client active.\" This occurs when a `LocalCluster` is used which has been created with more than one thread per worker. To reproduce this, use the following code:\r\n\r\n```python\r\nimport dask.array as da\r\nfrom distributed import Client, LocalCluster\r\n\r\ndef driver():\r\n    arr = da.random.default_rng().random((100, 100), chunks=(30, 30))\r\n    mean = da.nanmean(arr)\r\n    like_arr = da.full_like(arr, fill_value=mean).compute()\r\n\r\nif __name__ == '__main__':\r\n    cluster = LocalCluster(n_workers=2, threads_per_worker=2)\r\n    client = Client(cluster)\r\n\r\n    driver()\r\n```\r\n\r\nSometimes I have to run this multiple times to generate the failure, but it typically happens within 5 attempts. The error message looks like this:\r\n\r\n```\r\n  File \"/python/lib/python3.10/site-packages/dask/array/wrap.py\", line 140, in _broadcast_trick_inner\r\n    return np.broadcast_to(func(meta, *args, shape=null_shape, **kwargs), shape)\r\n  File \"<__array_function__ internals>\", line 180, in full_like\r\n  File \"/python/lib/python3.10/site-packages/numpy/core/numeric.py\", line 423, in full_like\r\n    multiarray.copyto(res, fill_value, casting='unsafe')\r\n  File \"<__array_function__ internals>\", line 180, in copyto\r\n  File \"/python/lib/python3.10/site-packages/dask/array/core.py\", line 1750, in __array_function__\r\n    return handle_nonmatching_names(func, args, kwargs)\r\n  File \"/python/lib/python3.10/site-packages/dask/array/core.py\", line 1726, in handle_nonmatching_names\r\n    args, kwargs = compute(args, kwargs)\r\n  File \"/python/lib/python3.10/site-packages/dask/base.py\", line 583, in compute\r\n    schedule = get_scheduler(\r\n  File \"/python/lib/python3.10/site-packages/dask/base.py\", line 1403, in get_scheduler\r\n    return get_scheduler(scheduler=config.get(\"scheduler\", None))\r\n  File \"/python/lib/python3.10/site-packages/dask/base.py\", line 1378, in get_scheduler\r\n    raise RuntimeError(\r\nRuntimeError: Requested dask.distributed scheduler but no Client active.\r\n```\r\n\r\nI've truncated the stack trace somewhat but I can post a longer one that goes back to the original call if that would be useful.\r\n\r\nThis toy example is distilled from a real example that we have in our codebase. We have not observed this failure with non-local clusters, but it does crop up with some regularity in CI, where we use a `LocalCluster` fixture for our testing. This is the only place where this error happens, and it goes away if I replace `da.full_like(arr, fill_value=mean)` with `da.full(arr.shape, fill_value=mean)`. The error also goes away if I create the `LocalCluster` with `threads_per_worker=1`.\r\n\r\nWhen debugging this issue, I drilled deep down into the `distributed/client.py` file where `default_client` is called (the error which gives rise to this `RuntimeError`) and I noticed that placing a delay after the line `c = c or _get_global_client()` eliminated this error; I discovered this by accident while trying to dump some information about the state of the client to a file. \r\n\r\n**Environment**:\r\n\r\n- Dask version: 2023.6.0\r\n- Python version: 3.10\r\n- Operating System: OS X, as well as linux/aarch64 (docker)\r\n- Install method (conda, pip, source): pip\r\n",
    "closed_by": null,
    "reactions": {
        "url": "https://api.github.com/repos/dask/dask/issues/10452/reactions",
        "total_count": 0,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 0,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/dask/dask/issues/10452/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}