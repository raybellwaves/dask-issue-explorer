[
    {
        "url": "https://api.github.com/repos/dask/dask/issues/comments/993983160",
        "html_url": "https://github.com/dask/dask/pull/8481#issuecomment-993983160",
        "issue_url": "https://api.github.com/repos/dask/dask/issues/8481",
        "id": 993983160,
        "node_id": "IC_kwDOAbcwm847Pvq4",
        "user": {
            "login": "gjoseph92",
            "id": 3309802,
            "node_id": "MDQ6VXNlcjMzMDk4MDI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3309802?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/gjoseph92",
            "html_url": "https://github.com/gjoseph92",
            "followers_url": "https://api.github.com/users/gjoseph92/followers",
            "following_url": "https://api.github.com/users/gjoseph92/following{/other_user}",
            "gists_url": "https://api.github.com/users/gjoseph92/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/gjoseph92/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/gjoseph92/subscriptions",
            "organizations_url": "https://api.github.com/users/gjoseph92/orgs",
            "repos_url": "https://api.github.com/users/gjoseph92/repos",
            "events_url": "https://api.github.com/users/gjoseph92/events{/privacy}",
            "received_events_url": "https://api.github.com/users/gjoseph92/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-12-14T20:49:19Z",
        "updated_at": "2021-12-14T20:49:19Z",
        "author_association": "MEMBER",
        "body": "> are we sure that HLGs are used in all cases?\r\n\r\nThe `.dask` of a DataFrame and Array should always be a HLG:\r\nhttps://github.com/dask/dask/blob/27a7928fb750d604dfbad0b3f4361aa64a2c97b4/dask/array/core.py#L1210-L1215\r\nhttps://github.com/dask/dask/blob/27a7928fb750d604dfbad0b3f4361aa64a2c97b4/dask/dataframe/core.py#L311-L313\r\n\r\nHowever `compute_as_if_collection` throws a wrench in things.\r\n\r\nI suppose we could take a different route and continue to allow the optimization functions to handle low-level graphs, even though the collections will never contain them, but add additional checks to the constructors to validate that the layer names are correct:\r\n```diff\r\ndiff --git a/dask/array/core.py b/dask/array/core.py\r\nindex 9ac28591..eebe07a7 100644\r\n--- a/dask/array/core.py\r\n+++ b/dask/array/core.py\r\n@@ -1212,6 +1212,10 @@ class Array(DaskMethodsMixin):\r\n         assert isinstance(dask, Mapping)\r\n         if not isinstance(dask, HighLevelGraph):\r\n             dask = HighLevelGraph.from_collections(name, dask, dependencies=())\r\n+        else:\r\n+            assert (\r\n+                name in dask.layers\r\n+            ), f\"{name!r} not in HLG layers: {list(dask.layers)}\"\r\n         self.dask = dask\r\n         self._name = str(name)\r\n         meta = meta_from_array(meta, dtype=dtype)\r\ndiff --git a/dask/dataframe/core.py b/dask/dataframe/core.py\r\nindex 8b0d7b3d..cb1ef881 100644\r\n--- a/dask/dataframe/core.py\r\n+++ b/dask/dataframe/core.py\r\n@@ -130,6 +130,8 @@ class Scalar(DaskMethodsMixin, OperatorMethodMixin):\r\n         # objects.\r\n         if not isinstance(dsk, HighLevelGraph):\r\n             dsk = HighLevelGraph.from_collections(name, dsk, dependencies=[])\r\n+        else:\r\n+            assert name in dsk.layers, f\"{name!r} not in HLG layers: {list(dsk.layers)}\"\r\n         self.dask = dsk\r\n         self._name = name\r\n         self._parent_meta = pd.Series(dtype=\"float64\")\r\n@@ -311,6 +313,8 @@ class _Frame(DaskMethodsMixin, OperatorMethodMixin):\r\n     def __init__(self, dsk, name, meta, divisions):\r\n         if not isinstance(dsk, HighLevelGraph):\r\n             dsk = HighLevelGraph.from_collections(name, dsk, dependencies=[])\r\n+        else:\r\n+            assert name in dsk.layers, f\"{name!r} not in HLG layers: {list(dsk.layers)}\"\r\n         self.dask = dsk\r\n         self._name = name\r\n         meta = make_meta(meta)\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/dask/dask/issues/comments/993983160/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]